<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisualEncounters Editor</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta property="og:image" content="viz-bg.jpg">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            image-rendering: optimizeSpeed;             /* STOP SMOOTHING, GIVE ME SPEED  */
            image-rendering: -moz-crisp-edges;          /* Firefox                        */
            image-rendering: -o-crisp-edges;            /* Opera                          */
            image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
            image-rendering: pixelated;                 /* Universal support since 2021   */
            image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
            -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */
        }
        .select2-results__option .enemy-option .option-preview, .select2-results__option .rank-option .option-preview{
            height:70px;
            width:70px;
        }
        /* Add to existing styles */
        .rank-option {
            display: flex;
            /*align-items: center;*/
            padding: 2px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .toolbar {
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .toolbar button {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .panel {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px;
        }
        .select2-container .select2-selection--single{
            height:40px !important; 
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(6, 130px);
            gap: 5px;
            margin-bottom: 20px;
        }
        .tile {
            width: 120px;
            height: 180px;
            border: 2px solid #ddd;
            border-radius: 5px;
            position: relative;
            overflow: visible;
            cursor: pointer;
        }
        .tile.selected {
            border-color: #0066ff;
            box-shadow: 0 0 10px rgba(0,102,255,0.5);
        }
        .tile-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom;
        }
        .tile-team {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom;
        }
        .tile-entity {
            position: absolute;
            width: 90%;
            height: 100%;
            left: 5%;
            top: 10%;
            z-index: 3;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom;
            transform-origin: center;
        }
        .properties-panel {
            margin-top: 20px;
        }
        .properties-panel label {
            display: block;
            margin: 10px 0 5px;
        }
        .properties-panel input, .properties-panel select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .status-message {
            margin-top: 10px;
            padding: 5px;
            border-radius: 3px;
            display: none;
        }
        .success { background-color: #dff0d8; color: #3c763d; }
        .error { background-color: #f2dede; color: #a94442; }
        .freedom-mission-options {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Add these new styles */
        .status-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 300px;
        }
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            margin-bottom: 10px;
        }
        .select2-container--default .select2-results__option {
            padding: 5px;
        }
        .enemy-option, .obstacle-option {
            display: flex;
            align-items: center;
        }
        .option-preview {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .toolbar {
            margin-bottom: 10px;
        }
        .panel h2 {
            margin-top: 0;
        }
        .properties-panel {
            transition: all 0.3s ease;
        }
        #enemy-rank-container {
            transition: all 0.3s ease;
        }
        #enemy-rank-container.hidden {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        /* Add to existing styles */
        body.dark-mode {
            background-color: #222;
            color: #eee;
        }

        body.dark-mode .panel {
            background-color: #333;
            color: #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        body.dark-mode .toolbar {
            background-color: #444;
        }

        body.dark-mode .tile {
            border-color: #555;
        }

        body.dark-mode .properties-panel input,
        body.dark-mode .properties-panel select{
            background-color: #444;
            color: #eee;
            border: 1px solid #555;
        }

        body.dark-mode .properties-panel span{
            background-color: #444;
            color: #fff !important;
        }
        body.dark-mode .select2-container--default .select2-selection--single, .select2-search__field,.select2-search .select2-search--dropdown {
            background-color: #444;
            color: #fff !important;
            border: 1px solid #555;
        }

        body.dark-mode .select2-container--default .select2-results__option {
            background-color: #444;
            color: #fff !important;
        }

        body.dark-mode .select2-container--default .select2-results__option--highlighted {
            background-color: #666;
            color: #fff !important;
        }
        body.darmode .select2-selection__rendered{
            color:#fff !important;
        }
        body.dark-mode .freedom-mission-options {
            background-color: #444;
            border-color: #555;
        }
            
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        body.dark-mode .modal-content {
            background-color: #333;
            color: #eee;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }

        .progress-bar {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 3px;
            margin: 10px 0;
        }

        body.dark-mode .progress-bar {
            background-color: #555;
        }
       
        .progress {
            height: 20px;
            border-radius: 3px;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            text-align: center;
            line-height: 20px;
            color: white;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <div class="toolbar">
      <!--  <button id="new-config">New Config</button> -->
        <button id="clear-all">Clear All</button>
        <button id="load-config">Load Config</button>
        <button id="save-config">Save Config</button>
        <select id="variation-select"></select>
        <button id="add-variation">Add Variation</button>
        <button id="delete-variation" disabled>Delete Variation</button>
        <button id="dark-mode-toggle" title="Toggle Dark Mode">☀️</button>
        <label style="margin-left: 10px; color: white;">
            <input type="checkbox" id="download-mods" checked> Download Mods?
        </label>
    </div>

    <div class="container">
        <div class="panel" id="grid-panel">
            <h2>Battle Grid</h2>
            <div class="grid-container" id="battle-grid"></div>
            
          <!-- <div class="properties-panel" id="main-properties">
                
            </div>-->

            <div class="properties-panel" id="variation-properties" style="display:none;">
                <h3>Main Configuration</h3>
                <label>Minimum Steps Before Encounter:
                    <input type="number" id="min-steps" min="0" step="1">
                </label>
                <label>Encounter Chance Per Step (0.00-1.00):
                    <input type="number" id="encounter-chance" min="0" max="1" step="0.01">
                </label>
                <h3>Battle Scenario Properties</h3>
                <label>Weight:
                    <input type="number" id="variation-weight" min="0" step="1">
                </label>
                <label>Music Path:
                    <input type="text" id="music-path">
                </label>
                <label>Results Callback:
                    <input type="text" id="results-callback">
                </label>
                <label>
                    <input type="checkbox" id="freedom-mission"> Freedom Mission
                </label>
                
                <div id="freedom-mission-options" class="freedom-mission-options" style="display:none;">
                    <label>Turn Count:
                        <input type="number" id="turn-count" min="1" step="1">
                    </label>
                    <label>
                        <input type="checkbox" id="player-can-flip"> Player can flip
                    </label>
                </div>
            </div>

            <div class="properties-panel" id="tile-properties" style="display:none;">
                <h3>Tile Properties</h3>
                <label>Team:
                    <select id="tile-team">
                        <option value="0">Neutral</option>
                        <option value="1">Blue</option>
                        <option value="2">Red</option>
                    </select>
                </label>
                <label>Tile Type:
                    <select id="tile-type">
                        <option value="1">Normal</option>
                        <option value="2">Cracked</option>
                        <option value="3">Broken</option>
                        <option value="4">Up</option>
                        <option value="5">Down</option>
                        <option value="6">Left</option>
                        <option value="7">Right</option>
                        <option value="8">Empty</option>
                        <option value="9">Grass</option>
                        <option value="10">Hidden</option>
                        <option value="11">Holy</option>
                        <option value="12">Ice</option>
                        <option value="13">Lava</option>
                        <option value="14">Poison</option>
                        <option value="15">Volcano</option>
                    </select>
                </label>
                <label>Content Type:
                    <select id="content-type">
                        <option value="none">None</option>
                        <option value="enemy">Enemy</option>
                        <option value="obstacle">Obstacle</option>
                        <option value="player">Player</option>
                    </select>
                </label>
                
                <div id="enemy-properties" style="display:none;">
                    <label>Enemy:
                        <select id="enemy-type"></select>
                    </label>
                    <div id="enemy-rank-container">
                        <label>Rank:
                            <select id="enemy-rank"></select>
                        </label><br>
                    </div>                    
                    <label>Nickname (optional):
                        <input type="text" id="enemy-nickname">
                    </label>
                </div>
                
                <div id="obstacle-properties" style="display:none;">
                    <label>Obstacle:
                        <select id="obstacle-type"></select>
                    </label>
                </div>
            </div>

            <div class="status-container">
                <div class="status-message" id="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        // Dictionaries for enemies with image paths and offsets
        const enemyDictionary = [
            //NAVIS
            { name: "VolcanoMan", image: "volcanoman.png", 
                package:"com.alrysc.enemy.VolcanoManEnemy",
                ranks: [
                    {value: 1, name: "VolcanoMan V1"},
                    {value: 2, name: "VolcanoMan V2"},
                ],
                downloads:[
                    "com_alrysc_enemy_VolcanoMan.zip"
                ],
                offsetX: 0,offsetY: 20,
            },
            { name: "Yuki", image: "Yuki.png", 
                package:"com.alrysc.enemy.YukiEnemy",
                ranks: [
                    {value: 1, name: "Yuki V1"},
                    {value: 2, name: "Yuki V2"},
                ],
                downloads:[
                    "com_alrysc_enemy_Yuki.zip"
                ],
                offsetX: 0,offsetY: 10,
            },
            { name: "Yumeko", image: "yumeko.png", 
                package:"com.alrysc.enemy.YumekoEnemy",
                ranks: [
                    {value: 1, name: "Yumeko V1"},
                    {value: 2, name: "Yumeko V2"},
                ],
                downloads:[
                    "com_alrysc_enemy_Yumeko.zip"
                ],
                offsetX: 0,offsetY: 0,
            },
            { name: "ShadeMan", image: "Object_shademan.png", 
                package:"com.Dawn.Enemy.Shademan",
                ranks: [
                    {value: 1, name: "ShadeMan V1"},
                    {value: 5, name: "ShadeMan EX"},
                    {value: 4, name: "ShadeMan SP"},
                ],
                downloads:[
                    "com_Dawn_Shademan.zip"
                ],
                offsetX: 0,offsetY: 0,
            },
            { name: "CutMan", image: "Object_cutman.png", 
                package:"com.louise.enemy.CutMan",
                ranks: [
                    {value: 1, name: "CutMan V1"},
                    {value: 5, name: "CutMan EX"},
                    {value: 4, name: "CutMan SP"},
                    {value: 8, name: "CutMan DS"},
                ],
                downloads:[
                    "com_louise_Cutman.zip"
                ],
                offsetX: 0,offsetY: 25,
            },
            { name: "DarkMega", nickname:"DarkMegaMan V1", image: "Object_darkmegaman.png", 
                package:"",
                ranks: [
                    {value: 1, name: ""},
                ],
                downloads:[
                    "com_Dawn_DarkRock.zip"
                ],
                offsetX: 0,offsetY: 30,
            },
            { name: "DarkMegaNM", nickname:"DarkMegaMan NM", image: "Object_darkmegaman.png", 
                package:"",
                ranks: [
                    {value: 8, name: ""},
                ],
                downloads:[
                    "com_Dawn_DarkRockNM.zip"
                ],
                offsetX: 0,offsetY: 30,
            },
            { name: "BlastMan", nickname:"BlastMan", image: "Blastman.webp", 
                package:"com.Thor.enemy.BlastMan_V1",
                ranks: [
                    {value: 1, name: "BlastMan"},
                    {value: 5, name: "BlastMan EX"},
                    {value: 4, name: "BlastMan SP"},
                   // {value: 6, name: "BlastMan RV"},
                ],
                downloads:[
                    "com_Thor_BlastMan_1.zip",
                    "com_Thor_BlastMan_2.zip",
                    "com_Thor_BlastMan_3.zip",
                   //"com_Thor_BlastMan_4.zip"
                ],
                offsetX: 0,offsetY: -10,
            },
            { name: "StarMan", nickname:"StarMan", image: "starman.png", 
                package:"com.OFC.char.EXE45-036-StarMan1",
                ranks: [
                    {value: 1, name: "StarMan"},
                    {value: 2, name: "StarMan V2"},
                    {value: 3, name: "StarMan V3"},
                    {value: 4, name: "StarMan SP"},
                ],
                downloads:[
                    "com_OFC_mob_EXE45_036_StarMan1.zip",
                    "com_OFC_mob_EXE45_036_StarMan2.zip",
                    "com_OFC_mob_EXE45_036_StarMan3.zip",
                    "com_OFC_mob_EXE45_036_StarMan4.zip"
                ],
                rankImages:{
                    4:"starman_sp.png",
                },
                offsetX: 0,offsetY: 0,
            },
            { name: "FireManPoN", nickname:"FireMan (PoN)", image: "Object_fireman-pon.png", 
                package:"com.OFC.char.EXEPoN-022-FireMan",
                ranks: [
                    {value: 1, name: "FireMan"},
                    {value: 2, name: "FireMan V2"},
                    {value: 3, name: "FireMan V3"},
                    {value: 4, name: "FireMan SP"},
                ],
                downloads:[
                    "com_OFC_mob_EXEPoN_022_FireManV1.zip",
                    "com_OFC_mob_EXEPoN_022_FireManV2.zip",
                    "com_OFC_mob_EXEPoN_022_FireManV3.zip",
                    "com_OFC_mob_EXEPoN_022_FireManV4.zip"
                ],
                offsetX: 0,offsetY: -10,
            },
            { name: "Forte", nickname:"Bass/Forte", image: "Object_bass-bn4.png", 
                package:"com.OFC.char.EXE4-047-Forte1",
                ranks: [
                    {value: 1, name: "Bass"},
                    {value: 4, name: "Bass SP"},
                    {value: 8, name: "Bass XX"},
                ],
                downloads:[
                    "com_OFC_mob_EXE4_047_Forte1.zip",
                    "com_OFC_mob_EXE4_047_Forte2.zip",
                    "com_OFC_mob_EXE4_047_Forte3.zip"
                ],
                offsetX: 0,offsetY: 10,
            },
            { name: "Alpha", image: "Alpha.webp", 
                package:"com.OFC.char.EXE3-061-Proto",
                ranks: [
                    {value: 1, name: "Alpha"},
                    {value: 4, name: "Alpha SP"},
                ],
                rankImages: {
                    4: "AlphaSP.webp",
                },
                downloads:[
                    "com_OFC_mob_EXE3_061_Proto.zip",
                    "com_OFC_mob_EXE3_061_ProtoSP.zip"
                ],
                offsetX: 0,offsetY: 0,
            },
            { name: "IceManPoN", nickname:"IceMan (PoN)", image: "Object_iceman-pon.png", 
                package:"com.OFC.char.EXEPoN-023-IceMan",
                ranks: [
                    {value: 1, name: "IceMan"},
                    {value: 2, name: "IceMan V2"},
                    {value: 3, name: "IceMan V3"},
                    {value: 4, name: "IceMan SP"},
                ],
                rankImages: {
                    1: "",
                    2: "",
                    3: "",
                    4: "",
                },
                downloads:[
                    "com_OFC_mob_EXEPoN_023_IceManV1.zip",
                    "com_OFC_mob_EXEPoN_023_IceManV2.zip",
                    "com_OFC_mob_EXEPoN_023_IceManV3.zip",
                    "com_OFC_mob_EXEPoN_023_IceManV4.zip"
                ],
                offsetX: 0,offsetY: 40,
            },
            { name: "ShadowManPoN", nickname:"ShadowMan (PoN)", image: "ShadowMan.webp", 
                package:"com.OFC.char.EXEPoN-025-ShadowMan",
                attachment:"",
                ranks: [
                    {value: 1, name: "ShadowMan"},
                    {value: 2, name: "ShadowMan V2"},
                    {value: 3, name: "ShadowMan V3"},
                    {value: 4, name: "ShadowMan SP"},
                ],
                rankImages: {
                    1: "ShadowMan.webp",
                    2: "ShadowManV2.webp",
                    3: "ShadowManV3.webp",
                    4: "ShadowManSP.webp",
                },
                downloads:[
                    "com_OFC_mob_EXEPoN_025_ShadowManV1.zip",
                    "com_OFC_mob_EXEPoN_025_ShadowManV2.zip",
                    "com_OFC_mob_EXEPoN_025_ShadowManV3.zip",
                    "com_OFC_mob_EXEPoN_025_ShadowManV4.zip"
                ],
                offsetX: 0,offsetY: 0,
            },
            { name: "Noir", image: "Noir.png", 
                package:"com.OctoChris.enemy.Noir",
                ranks: [
                    {value: 1, name: "Noir"},
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_OctoChris_mob_Noir.zip"],
            },
            { name: "GutsManPoN", nickname:"GutsMan (PoN)", image: "GutsMan.webp", 
                package:"com.OFC.char.EXEPoN-028-Blues",
                ranks: [
                    {value: 1, name: "GutsMan"},
                    {value: 2, name: "GutsMan V2"},
                    {value: 3, name: "GutsMan V3"},
                    {value: 4, name: "GutsMan SP"},
                    {value: 8, name: "GutsMan DS"},
                ],
                rankImages: {
                    1: "Gutsman.webp",
                    2: "GutsmanV2.webp",
                    3: "GutsmanV3.webp",
                    4: "GutsmanSP.webp",
                    8: "GutsmanDS.webp",
                },
                downloads:[
                    "com_OFC_mob_EXEPoN_026_GutsManV1.zip",
                    "com_OFC_mob_EXEPoN_026_GutsManV2.zip",
                    "com_OFC_mob_EXEPoN_026_GutsManV3.zip",
                    "com_OFC_mob_EXEPoN_026_GutsManV4.zip"
                ],
                offsetX: 0,offsetY: 50,
            },
            { name: "ProtomanPoN", nickname:"ProtoMan (PoN)", image: "Protoman.webp", 
                package:"com.OFC.char.EXEPoN-028-Blues",
                ranks: [
                    {value: 1, name: "ProtoMan"},
                    {value: 2, name: "ProtoMan V2"},
                    {value: 3, name: "ProtoMan V3"},
                    {value: 4, name: "ProtoMan SP"},
                ],
                rankImages: {
                    1: "Protoman.webp",
                    2: "ProtomanV2.webp",
                    3: "ProtomanV3.webp",
                    4: "ProtomanSP.webp",
                },
                offsetX: 0,offsetY: 25,
                downloads:[
                    "com_OFC_mob_EXEPoN_028_BluesV1.zip",
                    "com_OFC_mob_EXEPoN_028_BluesV2.zip",
                    "com_OFC_mob_EXEPoN_028_BluesV3.zip",
                    "com_OFC_mob_EXEPoN_028_BluesV4.zip",
                ],
            },
            { name: "WoodmanPoN", nickname:"WoodMan (PoN)", image: "WoodMan.webp", 
                package:"com.OFC.char.EXEPoN-024-WoodMan",
                ranks: [
                    {value: 1, name: "WoodMan"},
                    {value: 2, name: "WoodMan V2"},
                    {value: 3, name: "WoodMan V3"},
                    {value: 4, name: "WoodMan SP"},
                ],
                rankImages: {
                    1: "WoodMan.webp",
                    2: "WoodManV2.webp",
                    3: "WoodManV3.webp",
                    4: "WoodManSP.webp",
                },
                downloads:[
                    "com_OFC_mob_EXEPoN_024_WoodManV1.zip",
                    "com_OFC_mob_EXEPoN_024_WoodManV2.zip",
                    "com_OFC_mob_EXEPoN_024_WoodManV3.zip",
                    "com_OFC_mob_EXEPoN_024_WoodManV4.zip",
                ],
                offsetX: 0,offsetY: 0,
            },
            { name: "HatMan", nickname:"HatMan (PoN)", image: "hatman.png", 
                package:"com.alrysc.enemy.HatManEnemy",
                ranks: [
                    {value: 1, name: "HatMan"},
                    {value: 2, name: "HatMan V2"},
                    {value: 3, name: "HatMan V3"},
                    {value: 4, name: "HatMan SP"},
                ],
                rankImages: {
                    1: "",
                    2: "",
                    3: "",
                    4: "",
                },
                downloads:["com_alrysc_enemy_HatMan.zip"],
                offsetX: 0,offsetY: 0,
            },
            { name: "Roll", image: "roll.png", 
                package:"com.OFC.char.EXEPoN-027-Roll",
                ranks: [
                    {value: 1, name: "Roll"},
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_OFC_mob_EXEPoN_027_RollV1.zip"],
            },
            { name: "JammingMan", nickname:"JammingMan", image: "JammingMan.png", 
                package:"com.alrysc.enemy.JammingManEnemy",
                ranks: [
                    {value: 1, name: "JammingMan"},
                    {value: 2, name: "JammingMan V2"},
                    {value: 3, name: "JammingMan V3"},
                    {value: 4, name: "JammingMan SP"},
                ],
                rankImages: {
                    1: "",
                    2: "",
                    3: "",
                    4: "",
                },
                downloads:["com_alrysc_enemy_JammingManV1.zip"],
                offsetX: 0,offsetY: 0,
            },
            { name: "Kogasa", image: "Kogasa.png", 
                package:"com.alrysc.enemy.KogasaEnemy",
                ranks: [
                    {value: 1, name: "Kogasa"},
                    {value: 2, name: "Kogasa V2"},
                    {value: 3, name: "Kogasa V3"},
                ],
                rankImages: {
                    1: "",
                    2: "",
                    3: "",
                    4: "",
                },
                downloads:["com_alrysc_enemy_Kogasa.zip"],
                offsetX: 0,
                offsetY: 0,
            },
            { name: "CircusMan", image: "Object_circusman.png", 
                package:"com.louise.enemy.CircusMan",
                ranks: [
                    {value: 1, name: "CircusMan"},
                    {value: 5, name: "CircusMan EX"},
                    {value: 4, name: "CircusMan SP"},
                    {value: 8, name: "CircusMan NM"},
                ],
                rankImages: {
                    5: "", //add rank
                    4: "", //add rank
                    8: "", //add rank
                },
                downloads:["com_louise_CircusMan.zip"],
                offsetX: 0,
                offsetY: 30,
            },
            { name: "HeelNavi", image: "heelnavi.png", 
                package:"com.louise.enemy.HeelNavi",
                ranks: [
                    {value: 1, name: "HeelNavi"},
                    {value: 2, name: "HeelNavi V2"},
                    {value: 3, name: "HeelNavi V3"},
                    {value: 4, name: "HeelNavi SP"},
                ],
                rankImages: {
                    2: "", //add rank
                    3: "", //add rank
                    4: "", //add rank
                },
                downloads:["com_louise_HeelNavi.zip"],
                offsetX: 0,
                offsetY: 40,
            },
            { name: "QuickMan", image: "quickman.png", 
                package:"com.louise.enemy.Quickman",
                ranks: [
                    {value: 1, name: "QuickMan"},
                    {value: 2, name: "QuickMan V2"},
                    {value: 3, name: "QuickMan V3"},
                    {value: 4, name: "QuickMan SP"},
                    {value: 8, name: "QuickMan DS"},
                ],
                rankImages: {
                    4: "quickman-sp.png",
                    8: "quickman-ds.png",
                },
                downloads:["com_louise_Quickman.zip"],
                offsetX: 0,
                offsetY: 0,
            },
            //VIRUS
            { name: "DreamMeraru", image: "Object_scutz-pon.png", 
                package:"com.OFC.char.EXEPoN-018-DreamMeraru",
                ranks: [
                    {value: 1, name: "DreamMeraru"},
                    {value: 2, name: "DreamMeraru2"},
                    {value: 3, name: "DreamMeraru3"},
                    {value: 4, name: "DreamMeraru SP"},
                ],
                rankImages:{
                    2:"Object_scutz2-pon.png",
                    3:"Object_scutz3-pon.png",
                    4:"Object_scutzsp-pon.png",
                },
                offsetX: 0,offsetY: 50,
                downloads:["com_OFC_mob_EXEPoN_018_DreamMeraru.zip"]
            },
            { name: "DreamRapia", image: "Object_scuttle-pon.png", 
                package:"com.OFC.char.EXEPoN-018-DreamLapia",
                ranks: [
                    {value: 1, name: "DreamRapia"},
                    {value: 2, name: "DreamRapia2"},
                    {value: 3, name: "DreamRapia3"},
                    {value: 4, name: "DreamRapia SP"},
                ],
                rankImages:{
                    2:"Object_scuttle2-pon.png",
                    3:"Object_scuttle3-pon.png",
                    4:"Object_scuttlesp-pon.png",
                },
                offsetX: 0,offsetY: 50,
                downloads:["com_OFC_mob_EXEPoN_018_DreamMeraru.zip","com_OFC_mob_EXEPoN_019_DreamLapia.zip"]
            },
            { name: "DreamBolt", image: "Object_scuttler-pon.png", 
                package:"com.OFC.char.EXEPoN-018-DreamBolt",
                ranks: [
                    {value: 1, name: "DreamBolt"},
                    {value: 2, name: "DreamBolt2"},
                    {value: 3, name: "DreamBolt3"},
                    {value: 4, name: "DreamBolt SP"},
                ],
                rankImages:{
                    2:"Object_scuttler2-pon.png",
                    3:"Object_scuttler3-pon.png",
                    4:"Object_scuttlersp-pon.png",
                },
                offsetX: 0,offsetY: 50,
                downloads:["com_OFC_mob_EXEPoN_018_DreamMeraru.zip","com_OFC_mob_EXEPoN_020_DreamBolt.zip"]
            },
            { name: "DreamMoss", image: "Object_scuttzer-pon.png", 
                package:"com.OFC.char.EXEPoN-018-DreamMoss",
                ranks: [
                    {value: 1, name: "DreamMoss"},
                    {value: 2, name: "DreamMoss2"},
                    {value: 3, name: "DreamMoss3"},
                    {value: 4, name: "DreamMoss SP"},
                ],
                rankImages:{
                    2:"Object_scuttzer2-pon.png",
                    3:"Object_scuttzer3-pon.png",
                    4:"Object_scuttzersp-pon.png",
                },
                offsetX: 0,offsetY: 50,
                downloads:["com_OFC_mob_EXEPoN_018_DreamMeraru.zip","com_OFC_mob_EXEPoN_021_DreamMoss.zip"]
            },
            { name: "Yura", image: "Object_sparky-pon.png", 
                package:"com.OFC.char.EXEPoN-014-Yura",
                ranks: [
                    {value: 1, name: "Yura"},
                    {value: 4, name: "Yura SP"},
                ],
                rankImages:{
                    4:"Object_sparkysp-pon.png",
                },
                offsetX: 0,offsetY: 20,
                downloads:["com_OFC_mob_EXEPoN_014_Yura.zip"]
            },
            { name: "Yurayura", image: "Object_sparkler-pon.png", 
                package:"com.OFC.char.EXEPoN-014-Yurayura",
                ranks: [
                    {value: 1, name: ""},
                ],
                offsetX: 0,offsetY: 20,
                downloads:["com_OFC_mob_EXEPoN_014_Yura.zip"]
            },
            { name: "Yurarion", image: "Object_sparknoid-pon.png", 
                package:"com.OFC.char.EXEPoN-014-Yurarion",
                ranks: [
                    {value: 1, name: ""},
                ],
                offsetX: 0,offsetY: 20,
                downloads:["com_OFC_mob_EXEPoN_014_Yura.zip"]
            },
            { name: "Beetank", nickname:"Bugtank/Beetank (family)", image: "Object_beetank-pon.png", 
                package:"com.OFC.char.EXEPoN-007-Kabutank",
                ranks: [
                    {value: 1, name: "Beetank"},
                    {value: 2, name: "Beetank2"},
                    {value: 3, name: "Beetank3"},
                    {value: 4, name: "Beetank SP"},
                ],
                rankImages:{
                    2:"Object_beetank2-pon.png",
                    3:"Object_beetank3-pon.png",
                    4:"Object_beetanksp-pon.png",
                },
                offsetX: 0,offsetY: 50,
                downloads:["com_OFC_mob_EXEPoN_007_Kabutank.zip"]
            },
            { name: "Dharma", image: "Object_dharma-pon.png", 
                package:"com.OFC.char.EXEPoN-011-Dharma",
                ranks: [
                    {value: 1, name: "Dharma"},
                    {value: 4, name: "DharmaSP"},
                ],
                rankImages:{
                    4:"Object_dharmasp-pon.png"
                },
                offsetX: 0,offsetY: 55,
                downloads:["com_OFC_mob_EXEPoN_011_Dharma.zip"]
            },
            { name: "Dharga", nickname:"Karma", image: "Object_karma-pon.png", 
                package:"com.OFC.char.EXEPoN-011-Dharga",
                ranks: [
                    {value: 1, name: ""},
                ],
                offsetX: 0,offsetY: 55,
                downloads:["com_OFC_mob_EXEPoN_011_Dharma.zip"]
            },
            { name: "Dhardara", nickname:"Dogma", image: "Object_dogma-pon.png", 
                package:"com.OFC.char.EXEPoN-011-Dhardara",
                ranks: [
                    {value: 1, name: ""},
                ],
                offsetX: 0,offsetY: 55,
                downloads:["com_OFC_mob_EXEPoN_011_Dharma.zip"]
            },
            { name: "KillPlant", image: "Object_killplant-pon.png", 
                package:"com.OFC.char.EXEPoN-010-KillPlant",
                ranks: [
                    {value: 1, name: "KillPlant"},
                    {value: 4, name: "KillPlantSP"},
                ],
                rankImages:{
                    4:"Object_killplantsp-pon.png"
                },
                offsetX: 0,offsetY: 20,
                downloads:["com_OFC_mob_EXEPoN_010_KillPlant.zip"]
            },
            { name: "KillWeed", image: "Object_killweed-pon.png", 
                package:"com.OFC.char.EXEPoN-010-KillWeed",
                ranks: [
                    {value: 1, name: ""},
                ],
                offsetX: 0,offsetY: 20,
                downloads:["com_OFC_mob_EXEPoN_010_KillPlant.zip"]
            },
            { name: "KillFlower", image: "Object_killfleur-pon.png", 
                package:"com.OFC.char.EXEPoN-010-KillFlower",
                ranks: [
                    {value: 1, name: ""},
                ],
                
                offsetX: 0,offsetY: 20,
                downloads:["com_OFC_mob_EXEPoN_010_KillPlant.zip"]
            },
            { name: "SwapLight", image: "SwapLight.png", 
                package:"hoov.enemy.swaplight",
                ranks: [
                    {value: 1, name: ""},
                ],
                downloads:["hoov_package_swaplight.zip"],
                offsetX: 0,offsetY: 50,
            },
            { name: "ChefVirus", image: "chef.png", 
                package:"com.alrysc.enemy.ChefVirusEnemy",
                ranks: [
                    {value: 1, name: "ChefVirus"},
                ],
                offsetX: 0,offsetY: 35,
                downloads:["com_alrysc_enemy_ChefVirus.zip"],
            },
            { name: "Hecatia", image: "Hecatia.png", 
                package:"com.alrysc.enemy.HecatiaEnemy",
                ranks: [
                    {value: 1, name: "Hecatia"},
                    {value: 2, name: "Hecatia V2"},
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_alrysc_enemy_Hecatia.zip"],
            },
            { name: "RayCannon", image: "raycannon.png", 
                package:"com.alrysc.enemy.RayCannon_enemy",
                ranks: [
                    {value: 1, name: "RayCannon"},
                    {value: 2, name: "RayCannon2"}, 
                    {value: 3, name: "RayCannon3"}, 
                    {value: 5, name: "RayCannon EX"}, 
                    {value: 0, name: "RayCannon SP"},
                ],
                offsetX: 0,offsetY: 0,
                rankImages: {
                    1: "",
                    2: "",
                    3: "",
                    5: "",
                    0: "",
                },
                downloads:["com_alrysc_enemy_RayCannon.zip"],
                
            },
            { name: "Mettaur", nickname: "Mettaur (family)", image: "mettaur.png", 
                package:"com.keristero.char.Mettaur",
                ranks: [
                    {value: 1, name: "Mettaur"},
                    {value: 2, name: "Mettaur2"}, 
                    {value: 3, name: "Mettaur3"}, 
                    {value: 4, name: "MettaurSP"},
                    {value: 6, name: "RareMettaur1"}, 
                    {value: 7, name: "RareMettaur2"},
                ],
                offsetX: 0,offsetY: 60,
                rankImages: {
                    1: "mettaur.png",
                    2: "Mettaur2.webp",
                    3: "Mettaur3.webp",
                    4: "MettaurOmega.webp",
                    6: "MettaurRare1.webp",
                    7: "MettaurRare2.webp",
                },
                downloads:["com_keristero_mob_Mettaur.zip"],
            },
            { name: "Champy", image: "champy.png", 
            package:"com.keristero.char.Champy",
                ranks: [
                    {value: 1, name: "Champy"},
                    {value: 2, name: "ChampySP"}
                ],
                rankImages: {
                    2: "champysp.png",
                },
                offsetX: 0,offsetY: 20,
                downloads:["com_keristero_mob_Champy.zip"],
            },
            { name: "Chimpy", image: "chimpy.png", 
            package:"com.keristero.char.Chimpy",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 20, 
                downloads:["com_keristero_mob_Champy.zip"],
            },
            { name: "Chumpy", image: "chumpy.png", 
            package:"com.keristero.char.Chumpy",
                ranks: [
                    {value: 1, name: ""}
                ],
                downloads:["com_keristero_mob_Champy.zip"],
                offsetX: 0,offsetY: 20 
            },
            { name: "RareChampy", image: "rarechampy.png", 
            package:"com.keristero.char.RareChampy",
            package:"",
                ranks: [
                    {value: 1, name: ""}
                ],
                downloads:["com_keristero_mob_Champy.zip"],
                offsetX: 0,offsetY: 20 
            },
            { name: "Cactikil", image: "cactikil.webp", 
            package:"com.discord.Konstinople#7692.enemy.cactikil",
                ranks: [
                    {value: 1, name: "Cactikil"},
                    {value: 5, name: "CactikilEX"}
                ],
                rankImages: {
                    5: "CactkilEX.webp"
                },
                downloads:["com_discord_Konstinople_7692_cactikil.zip"],
                offsetX: 0,offsetY: 0 
            },
            { name: "Cactroll", image: "cactroll.webp", 
            package:"com.discord.Konstinople#7692.enemy.cactroll",
                ranks: [
                    {value: 1, name: "Cactroll"},
                    {value: 5, name: "CactrollEX"}
                ],
                rankImages: {
                    5: "CactrlEX.webp",
                },
                downloads:["com_discord_Konstinople_7692_cactikil.zip"],
                offsetX: 0,offsetY: 0 
            },
            { name: "Cacter", image: "cacter.webp", 
            package:"com.discord.Konstinople#7692.enemy.cacter",
                ranks: [
                    {value: 1, name: "Cacter"},
                    {value: 5, name: "CacterEX"}
                ],
                rankImages: {
                    5: "CacterEX.webp"
                },
                downloads:["com_discord_Konstinople_7692_cactikil.zip"],
                offsetX: 0,offsetY: 0 
            },
            { name: "Powie", image: "Object_powie-bn5.png", 
            package:"com.discord.Konstinople#7692.enemy.powie",
                ranks: [
                    {value: 1, name: "Powie"},
                    {value: 5, name: "Powie EX"}
                ],
                rankImages:{
                    5:"Object_powieex.png",
                },
                downloads:["com_discord_Konstinople_7692_powie.zip"],
                offsetX: 0,offsetY: 7 
            },
            { name: "Powie2", image: "Object_powie2-bn5.png", 
            package:"com.discord.Konstinople#7692.enemy.powie2",
                ranks: [
                    {value: 1, name: "Powie2"},
                    {value: 5, name: "Powie2 EX"}
                ],
                rankImages:{
                    5:"Object_powie2ex.png",
                },
                downloads:["com_discord_Konstinople_7692_powie.zip"],
                offsetX: 0,offsetY: 7 
            },
            { name: "Powie3", image: "Object_powie3-bn5.png", 
            package:"com.discord.Konstinople#7692.enemy.powie3",
                ranks: [
                    {value: 1, name: "Powie3"},
                    {value: 5, name: "Powie3 EX"}
                ],
                rankImages:{
                    5:"Object_powie3ex.png",
                },
                downloads:["com_discord_Konstinople_7692_powie.zip"],
                offsetX: 0,offsetY: 7 
            },
            { name: "Spikey", image: "Object_spikey-pon.png", 
            package:"com.Dawn.char.Spikey",
                ranks: [
                    {value: 1, name: "Spikey"},
                    {value: 2, name: "Spikey2"},
                    {value: 3, name: "Spikey3"},
                    {value: 4, name: "SpikeySP"}
                ],
                rankImages:{
                    2:"Object_spikey2-pon.png",
                    3:"Object_spikey3-pon.png",
                    4:"Object_spikeysp-pon.png",
                },
                downloads:["com_Dawn_mob_Spikey.zip"],
                offsetX: 0,offsetY: 60, 
            },
            { name: "Cannodumb", name: "Cannodumb (family)", image: "Object_canodumb-pon.png", 
            package:"com.OFC.char.EXEPoN-002-Cannodumb",
                ranks: [
                    {value: 1, name: "Cannodumb"},
                    {value: 2, name: "Cannodumb2"},
                    {value: 3, name: "Cannodumb3"},
                    {value: 4, name: "Cannodumb SP"}
                ],
                rankImages:{
                    2:"Object_canodumb2-pon.png",
                    3:"Object_canodumb3-pon.png",
                    4:"Object_canodumbsp-pon.png",
                },
                offsetX: 0,offsetY: 0,
                downloads:["com_OFC_mob_EXEPoN_002_Cannodumb.zip"]
            },
            { name: "Gunner", image: "gunner.png", 
            package:"com.keristero.char.Gunner",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 23,
                downloads:["com_keristero_mob_Gunner.zip"],
            },
            { name: "Shooter", image: "shooter.png", 
            package:"com.keristero.char.Shooter",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                downloads:["com_keristero_mob_Gunner.zip"],
                offsetX: 0,offsetY: 23 
            },
            { name: "Sniper", image: "sniper.png", 
            package:"com.keristero.char.Sniper",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 23,
                downloads:["com_keristero_mob_Gunner.zip"],
            },
            { name: "BigBrute", image: "bigbrute.png", 
            package:"com.keristero.char.BigBrute",
                ranks: [
                    {value: 1, name: ""}
                ],
                downloads:["com_keristero_mob_BigBrute.zip"],
                offsetX: 0,offsetY: 35 
            },
            { name: "Volgear", nickname:"Volgear (family)", image: "Object_volgear-bn4.png", 
            package:"com.louise.char.Volgear",
                ranks: [
                    {value: 1, name: "Volgear"},
                    {value: 2, name: "Vulgear"},
                    {value: 3, name: "Valgear"},
                    {value: 4, name: "ValgearEX"}
                ],
                rankImages:{
                    2:"Object_vulgear.png",
                    3:"Object_valgear.png",
                    4:"Object_valgearex.png",
                },
                offsetX: 0,offsetY: 35,
                downloads:["com_louise_Volgear.zip"],
            },
            { name: "KillerEye", image: "Object_killereye-bn6.png", 
            package:"com.louise.char.KillerEye",
                ranks: [
                    {value: 1, name: "KillerEye"},
                    {value: 4, name: "KillerEyeSP"},
                    {value: 6, name: "RareKillerEye1"},
                    {value: 7, name: "RareKillerEye2"}
                ],
                rankImages:{
                    4:"Object_killereyesp.png",
                    6:"Object_rarekillereye.png",
                    7:"Object_rarekillereye2.png",
                },
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_KillerEye.zip"], 
            },
            { name: "DemonEye", image: "DemonEye1.webp", 
            package:"",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_KillerEye.zip"], 
            },
            { name: "JokerEye", image: "JokerEye1.webp", 
            package:"",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_KillerEye.zip"], 
            },
            { name: "HauntedCandle", image: "HauntedCandle.webp", 
            package:"",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 7, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_HauntedCandle.zip"],
            },
            { name: "Fishy", nickname:"Fishy (family)", image: "Object_fishy-bn2.png", 
            package:"",
                ranks: [
                    {value: 1, name: "Fishy"},
                    {value: 2, name: "Fishy2"},
                    {value: 3, name: "Fishy3"},
                    {value: 4, name: "FishySP"},
                    {value: 6, name: "RareFishy1"},
                    {value: 7, name: "RareFishy2"},
                    {value: 8, name: "FishyNM"},
                ],
                rankImages:{
                    2:"Object_fishy2-bn2.png",
                    3:"Object_fishy3.png",
                    4:"Object_fishyomega.png",
                    6:"Object_fishy-r1.png",
                    7:"Object_fishy-r2-bn2.png",
                    8:"Object_fishy-nm.png",
                },
                downloads:["com_louise_Fishy.zip"],
                offsetX: 10,offsetY: 17 
            },
            { name: "BombCorn", image: "BombCorn.webp", 
            package:"com.louise.enemy.Corn.BombCorn",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_Corn.zip"],
            },
            { name: "MegaCorn", image: "MegaCorn.webp", 
            package:"com.louise.enemy.Corn.MegaCorn",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_Corn.zip"], 
            },
            { name: "GigaCorn", image: "GigaCorn.webp", 
            package:"com.louise.enemy.Corn.GigaCorn",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_Corn.zip"], 
            },
            { name: "Bladia", image: "Object_bladia.png", 
            package:"com.EXE5.Bladia.Enemy",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_EXE5_Bladia.zip"],
            },
            { name: "Bladia2", image: "Object_bladia2.png", 
            package:"com.EXE5.Bladia.Enemy2",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_EXE5_Bladia.zip"], 
            },
            { name: "Bladia3", image: "Object_bladia3.png", 
            package:"com.EXE5.Bladia.Enemy3",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_EXE5_Bladia.zip"], 
            },
            { name: "Bladia4", image: "Object_bladia4.png", 
            package:"com.EXE5.Bladia.Enemy4",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_EXE5_Bladia.zip"], 
            },
            { name: "Bladia5", image: "Object_bladia5.png", 
            package:"com.EXE5.Bladia.Enemy5",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_EXE5_Bladia.zip"], 
            },
            { name: "Bladia6", image: "Object_bladia6.png", 
            package:"com.EXE5.Bladia.Enemy6",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_EXE5_Bladia.zip"], 
            },
            { name: "Metrid", image: "Metrid1.webp", 
            package:"com.EXE3.Metrid.Enemy",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 13,
                downloads:["com_EXE3_Metrid.zip"]
            },
            { name: "Basher", image: "Basher.webp", 
            package:"com.EXE3.Basher.Enemy",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 13,
                downloads:["com_EXE3_Basher.zip"]
            },
            { name: "FighterPlane", image: "FighterPlane.webp", 
            package:"com.Dawn.Viruses.Enemy.FighterPlane",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 35,
                downloads:[""],
            },
            { name: "Catack", image: "Catack.webp", 
            package:"com.Dawn.Requested.Enemy.Catack",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 35,
                downloads:["com_Dawn_Requested_Catack.zip"],
            },
            { name: "Ratty", image: "Ratty1.webp", 
            package:"",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 75,
                downloads:["com_Dawn_BN3_Ratty.zip"],
            },
            { name: "Yort", image: "Yort1.webp", 
            package:"com.louise.enemy.Yort",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 5, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 45,
                downloads:["com_louise_Yort.zip"], 
            },
            { name: "Volcano", image: "Volcano.webp", 
            package:"com.louise.enemy.Volcano",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 5, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 45,
                downloads:["com_louise_Volcano.zip"], 
            },
            { name:"Swordy", nickname: "Swordy (family)", image: "Swordy1.webp", 
            package:"com_louise_Swordy.zip",
            ranks: [
                {value: 1, name: ""},
                {value: 2, name: ""},
                {value: 3, name: ""},
                {value: 4, name: ""},
                {value: 8, name: ""}
            ],
            offsetX: 0,offsetY: 0,
            downloads:["com.louise.enemy.Swordy"], 
            },
            { 
                name:"SwordyEl", 
                nickname: "Swordy (Elemental)", 
                image: "Swordy1.webp", 
                package:"encounter_realms_rey_virus_009_swordy.zip",
                ranks: [
                    {value: 1, name: "Burny"},
                    {value: 2, name: "Splashy"},
                    {value: 3, name: "Shocky"},
                    {value: 4, name: "Sappy"},
                    {value: 5, name: "Breezy"},
                    {value: 6, name: "Scummy"},
                    {value: 7, name: "Achey"},
                    {value: 8, name: "\u{0027}Splodey"},
                ],
                offsetX: 0,offsetY: 0,
                downloads:[
                    "encounter_realms_rey_virus_009_swordy.zip"
                ]
            },
            { name: "Skarab", image: "Skarab.webp", 
            package:"com.louise.enemy.Skarab",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 25,
                downloads:["com_louise_Skarab.zip"], 
            },
            { name: "Skarry", image: "Skarry1.webp", 
            package:"com.louise.enemy.Skarry",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 25,
                downloads:["com_louise_Skarab.zip"], 
            },
            { name: "Skelly", image: "Skelly1.webp", 
            package:"com.louise.enemy.Skelly",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 25,
                downloads:["com_louise_Skarab.zip"], 
            },
            { name: "Scuttle", image: "Scuttle1.webp", 
            package:"com.louise.enemy.Scuttle",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Scutz.zip"], 
            },
            { name: "Scutz", image: "Scutz1.webp", 
            package:"com.louise.enemy.Scutz",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Scutz.zip"], 
            },
            { name: "Scuttler", image: "Scuttler1.webp", 
            package:"com.louise.enemy.Scuttler",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Scutz.zip"], 
            },
            { name: "Scuttzer", image: "Scutzer1.webp", 
            package:"com.louise.enemy.Scuttzer",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Scutz.zip"], 
            },
            { name: "Scuttlest", image: "Scuttlest1.webp", 
            package:"com.louise.enemy.Scuttlest",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Scutz.zip"], 
            },
            { name: "Lark", image: "Lark1.webp", 
            package:"com.louise.enemy.Lark",
                ranks: [
                    {value: 1, name: "Lark"},
                    {value: 4, name: "LarkSP"},
                    {value: 6, name: "RareLark1"},
                    {value: 7, name: "RareLark2"},
                    {value: 8, name: "LarkNM"}
                ],
                rankImages: {
                    4: "",
                    6: "",
                    7: "",
                    8: "",
                },
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Lark.zip"], 
            },
            { name: "Bark", image: "Bark1.webp", 
            package:"com.louise.enemy.Bark",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Lark.zip"], 
            },
            { name: "Tark", image: "Tark1.webp", 
            package:"com.louise.enemy.Tark",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 50,
                downloads:["com_louise_Lark.zip"], 
            },
            { name: "Flashy", image: "Flashy1.webp", 
            package:"com.louise.enemy.Flashy",
                ranks: [
                    {value: 1, name: "Flashy"},
                    {value: 2, name: "Flashy2"},
                    {value: 3, name: "Flashy3"},
                    {value: 6, name: "RareFlashy1"},
                    {value: 7, name: "RareFlashy2"},
                    {value: 4, name: "FlashySP"},
                    {value: 8, name: "FlashyNM"}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_Flashy.zip"], 
            },
            { name: "MetFire", image: "MetFire1.webp", 
            package:"com.louise.enemy.MetFire",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_exe2_MetFire.zip"]
            },
            { name: "FulFire", image: "FulFire1.webp", 
            package:"com.louise.enemy.FulFire",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_exe2_MetFire.zip"] 
            },
            { name: "DthFire", image: "DthFire1.webp", 
            package:"com.louise.enemy.DthFire",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_exe2_MetFire.zip"]
            },
            { name: "Elemperor", image: "Elemperor.webp", 
            package:"com.louise.enemy.Elemperor",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 30,
                downloads:["com_louise_Elemperor.zip"], 
            },
            { name: "Dominerd", image: "Dominerd.webp", 
            package:"com.louise.enemy.Dominerd",
                ranks: [
                    {value: 1, name: "Dominerd"},
                    {value: 2, name: "Dominerd2"},
                    {value: 3, name: "Dominerd3"},
                    {value: 4, name: "Dominerd SP"},
                    {value: 8, name: "Dominerd NM"}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Dominerd.zip"], 
            },
            { name: "Cragger", image: "Cragger.webp", 
            package:"com.louise.enemy.Cragger",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 15,
                downloads:["com_louise_Cragger.zip"], 
            },
            { name: "Juraigon", image: "juraigon.png", 
            package:"com.alrysc.enemy.juraigonVirus",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_alrysc_enemy_juraigon.zip"], 
            },
            { name: "DarkMech", image: "DarkMech.webp", 
            package:"com.HNST_SGNL.enemy.DarkMech",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_HNST_SGNL_DarkMech.zip"], 
            },
            { name: "CirKill", image: "CirKill.webp", 
            package:"com.louise.enemy.CirKill",
                ranks: [
                    {value: 1, name: ""},
                    {value: 4, name: ""},
                    {value: 6, name: ""},
                    {value: 7, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 35,
                downloads:["com_louise_CirKill.zip"], 
            },
            { name: "CirCrush", image: "CirCrush.webp", 
            package:"com.louise.enemy.CirCrush",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 35,
                downloads:["com_louise_CirKill.zip"], 
            },
            { name: "CirSmash", image: "CirSmash.webp", 
            package:"com.louise.enemy.CirSmash",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 35,
                downloads:["com_louise_CirKill.zip"], 
            },
            { name: "WindBox", image: "WindBox.webp", 
            package:"com.louise.enemy.WindBox",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""},
                    {value: 8, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_WindBox.zip"], 
            },
            { name: "VacuumFan", image: "VacuumFan.webp", 
            package:"com.louise.enemy.VacuumFan",
                ranks: [
                    {value: 1, name: ""},
                    {value: 2, name: ""},
                    {value: 3, name: ""},
                    {value: 4, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_WindBox.zip"],
            },
            { name: "OldStove", image: "OldStove.webp", 
            package:"com.louise.enemy.OldStove",
                ranks: [
                    {value: 1, name: "OldStove"},
                    {value: 4, name: "OldStoveSP"},
                    {value: 6, name: "RareOldStove1"},
                    {value: 7, name: "RareOldStove2"},
                    {value: 8, name: "OldStoveNM"}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_OldStove.zip"], 
            },
            { name: "OldHeater", image: "OldHeater.webp", 
            package:"com.louise.enemy.OldHeater",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_OldStove.zip"], 
            },
            { name: "OldBurner", image: "OldBurner.webp", 
            package:"com.louise.enemy.OldBurner",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 10,
                downloads:["com_louise_OldStove.zip"], 
            },
            { name: "Bunny", image: "Bunny1.webp", 
            package:"com.louise.enemy.Bunny",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Bunny.zip"], 
            },
            { name: "TuffBunny", image: "Bunny2.webp", 
            package:"com.louise.enemy.TuffBunny",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Bunny.zip"], 
            },
            { name: "MegaBunny", image: "Bunny3.webp", 
            package:"com.louise.enemy.MegaBunny",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Bunny.zip"], 
            },
            { name: "Shrimpy", nickname:"Shrimpy (family)", image: "Shrimpy.webp", 
            package:"com.louise.enemy.Shrimpy",
                ranks: [
                    {value: 1, name: "Shrimpy"},
                    {value: 2, name: "Shrimpy2"},
                    {value: 3, name: "Shrimpy3"},
                    {value: 4, name: "ShrimpySP"},
                    {value: 6, name: "RareShrimpy1"},
                    {value: 7, name: "RareShrimpy2"},
                    {value: 8, name: "ShrimpyNM"}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Shrimpy.zip"], 
            },
            { name: "Puffy", image: "Object_bn6puffy.png", 
            package:"com.louise.enemy.Puffy",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 60,
                downloads:["com_louise_Puffy.zip"], 
            },
            { name: "HardHead", image: "HardHead.webp", 
            package:"com.louise.enemy.HardHead",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_louise_HardHead.zip"], 
            },
            { name: "HotHead", image: "HotHead.webp", 
            package:"com.louise.enemy.HotHead",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_louise_HardHead.zip"], 
            },
            { name: "ColdHead", image: "ColdHead.webp", 
            package:"com.louise.enemy.ColdHead",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 40,
                downloads:["com_louise_HardHead.zip"], 
            },
            { name: "Boomer", image: "Boomer.webp", 
            package:"com.louise.enemy.Boomer",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Boomer.zip"], 
            },
            { name: "Gloomer", image: "Gloomer.webp", 
            package:"com.louise.enemy.Gloomer",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Boomer.zip"], 
            },
            { name: "Doomer", image: "Doomer.webp", 
            package:"com.louise.enemy.Doomer",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Boomer.zip"], 
            },
            { name: "Piranha", image: "Piranha.webp", 
            package:"com.louise.enemy.Piranha",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Piranha.zip"], 
            },
            { name: "Quaker", image: "Quaker.webp", 
            package:"com.louise.enemy.Quaker",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Quaker.zip"], 
            },
            { name: "Shaker", image: "Shaker.webp", 
            package:"com.louise.enemy.Shaker",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Quaker.zip"], 
            },
            { name: "Breaker", image: "Breaker.webp", 
            package:"com.louise.enemy.Breaker",
                ranks: [
                    {value: 1, name: ""}
                ],
                offsetX: 0,offsetY: 0,
                downloads:["com_louise_Quaker.zip"], 
            }
        ];
    
        //Defines obstacles with image paths and offsets
        const obstacleDictionary = [
            { name: "None", image: "" },
            { name: "Rock", image: "obstacles/rock.png",offsetX: 0,offsetY: 60 },
            { name: "RockCube", image: "obstacles/rockcube.png",offsetX: 0,offsetY: 24 },
            { name: "Coffin", image: "obstacles/coffin.png",offsetX: 0,offsetY: 80 },
            { name: "BlastCube", image: "obstacles/blastcube.png",offsetX: 0,offsetY: 26 },
            { name: "IceCube", image: "obstacles/icecube.png",offsetX: 0,offsetY: 26 },
            { name: "MysteryData", image: "obstacles/mysterydata.png",offsetX: 0,offsetY: 26 }
        ];
    
        //Defines tile types with image paths and offsets
        const tileDictionary = {
            1: { name: "normal", image: "tile/normal.png",offsetX: 0,offsetY: 105 },
            2: { name: "cracked", image: "tile/cracked.png",offsetX: 0,offsetY: 105 },
            3: { name: "broken", image: "tile/broken.png",offsetX: 0,offsetY: 105 },
            4: { name: "up", image: "tile/up.png",offsetX: 0,offsetY: 105 },
            5: { name: "down", image: "tile/down.png",offsetX: 0,offsetY: 105 },
            6: { name: "left", image: "tile/left.png",offsetX: 0,offsetY: 105 },
            7: { name: "right", image: "tile/right.png",offsetX: 0,offsetY: 105 },
            8: { name: "empty", image: "tile/hole.png",offsetX: 0,offsetY: 105 },
            9: { name: "grass", image: "tile/grass.png",offsetX: 0,offsetY: 105 },
            10: { name: "hidden", image: "",offsetX: 0,offsetY: 105 },
            11: { name: "holy", image: "tile/holy.png",offsetX: 0,offsetY: 105 },
            12: { name: "ice", image: "tile/ice.png",offsetX: 0,offsetY: 105 },
            13: { name: "lava", image: "tile/lava.png",offsetX: 0,offsetY: 105 },
            14: { name: "poison", image: "tile/poison.png",offsetX: 0,offsetY: 105 },
            15: { name: "volcano", image: "tile/volcano.png",offsetX: 0,offsetY: 105 }
        };
    
        //Defines team tile colors with image paths and offsets
        const teamDictionary = {
            0: { name: "neutral", image: "tile/neutral.png",offsetX: 0,offsetY: 105},
            1: { name: "blue", image: "tile/blue.png",offsetX: 0,offsetY: 105 },
            2: { name: "red", image: "tile/red.jpg",offsetX: 0,offsetY: 105 }
        };
    
        //Megaman.EXE placeholder for player with image paths and offsets
        const playerDictionary = {
            player: {
                name: "Player",
                image: "player.png",
                offsetX: 0,
                offsetY: 25
            }
        };

    </script>
    <script>
    const DEBUG_MODE = true;

// =============================================
// Dark Mode Functions
// =============================================

function initializeDarkMode() {
    const darkMode = localStorage.getItem('darkMode') === 'true';
    toggleDarkMode(darkMode, false);
    
    $('#dark-mode-toggle').click(function() {
        const newMode = !$('body').hasClass('dark-mode');
        toggleDarkMode(newMode, true);
    });
}

function toggleDarkMode(enabled, saveToStorage) {
    if (enabled) {
        $('body').addClass('dark-mode');
        $('#dark-mode-toggle').text('Light Mode');
    } else {
        $('body').removeClass('dark-mode');
        $('#dark-mode-toggle').text('Dark Mode');
    }
    
    if (saveToStorage) {
        localStorage.setItem('darkMode', enabled);
    }
}

// =============================================
// Configuration and Data Structures
// =============================================

// Default configuration
let config = {
    minimum_steps_before_encounter: 80,
    encounter_chance_per_step: 0.05,
    encounters: []
};

// Current state
let currentVariationIndex = -1;
let selectedTile = null;

// Default team positions (first 3 columns red, last 3 blue)
const defaultTeamPositions = [
    [2, 2, 2, 1, 1, 1],
    [2, 2, 2, 1, 1, 1],
    [2, 2, 2, 1, 1, 1]
];

// =============================================
// Mod Download Functions
// =============================================

function showDownloadInfoModal() {
    if ($('#download-mods').is(':checked')) {
        const modal = $(`
            <div class="modal-overlay">
                <div class="modal-content">
                    <span class="modal-close">&times;</span>
                    <h2>Mod Downloads</h2>
                    <p>If checked, all required mod files will be automatically downloaded in a zip file when saving config.</p>
                    <p>The zip will include all enemy mods used in your configuration plus the required master ezencounters.zip file.</p>
                    <p>You must put these in your server's assets/ezlibs-assets/ezencounters/ folder.</p>
                    <div class="progress-bar" style="display:none;">
                        <div class="progress">0%</div>
                    </div>
                </div>
            </div>
        `);
        
        modal.find('.modal-close, .modal-overlay').click(function() {
            modal.remove();
        });
        
        $('body').append(modal);
    }
}

function getRequiredDownloads() {
    const downloads = new Set();
    
    // Add the required ezencounters.zip
    downloads.add('ezencounters.zip');
    
    // Add downloads from all enemies in all variations
    config.encounters.forEach(variation => {
        if (variation.enemies) {
            variation.enemies.forEach(enemy => {
                const enemyDef = enemyDictionary.find(e => e.name === enemy.name);
                if (enemyDef && enemyDef.downloads) {
                    enemyDef.downloads.forEach(d => downloads.add(d));
                }
            });
        }
    });
    
    return Array.from(downloads);
}

async function downloadModFiles() {
    if (!$('#download-mods').is(':checked')) {
        return Promise.resolve();
    }
    
    const downloads = getRequiredDownloads();
    if (downloads.length === 0) {
        return Promise.resolve();
    }
    
    const modal = $('.modal-overlay');
    const progressBar = modal.find('.progress-bar').show();
    const progress = progressBar.find('.progress');
    
    try {
        // Create a new JSZip instance
        const JSZip = await loadJSZip();
        const zip = new JSZip();
        
        // Download each file and add to zip
        for (let i = 0; i < downloads.length; i++) {
            const url = "mods/"+downloads[i];
            //const filename = url.split('/').pop();
            const filename = downloads[i];
            try {
                progress.text(`Downloading ${filename}... (${i+1}/${downloads.length})`);
                progress.css('width', `${(i / downloads.length) * 100}%`);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to download ${url}`);
                
                const blob = await response.blob();
                zip.file(filename, blob);
                
                progress.css('width', `${((i + 1) / downloads.length) * 100}%`);
            } catch (err) {
                console.error(`Failed to download ${url}:`, err);
                // Continue with next file even if one fails
            }
        }
        
        // Generate the zip file
        progress.text('Creating zip file...');
        const content = await zip.generateAsync({ type: 'blob' }, metadata => {
            progress.css('width', `${metadata.percent}%`);
            progress.text(`Creating zip... ${Math.round(metadata.percent)}%`);
        });
        
        // Download the zip
        const zipUrl = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = zipUrl;
        a.download = 'required_mods.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(zipUrl);
        
        progress.text('Download complete!');
        setTimeout(() => modal.remove(), 2000);
    } catch (err) {
        console.error('Error creating mod zip:', err);
        progress.text('Error creating zip file');
        progress.css('background-color', '#f44336');
    }
}

function loadJSZip() {
    return new Promise((resolve, reject) => {
        if (window.JSZip) {
            resolve(window.JSZip);
        } else {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = () => resolve(window.JSZip);
            script.onerror = reject;
            document.body.appendChild(script);
        }
    });
}

// =============================================
// Initialization Functions
// =============================================

function initializeEditor() {
    // Load lastest edits from local storage or create default config
    loadFromLocalStorage();
    
    // Set up UI elements
    initializeGrid();
    populateEnemyDropdown(); //Populate viruses
    populateObstacleDropdown(); //Populate obstacles
    updateEnemyRankOptions(enemyDictionary[0].name); // Initialize ranks
    refreshVariationDropdown();
    
    // Initialize Select2 for dropdowns
    $('#enemy-type').select2({
        templateResult: formatEnemyOption,
        templateSelection: formatEnemyOption,
        width: '100%'
    });
    
    $('#obstacle-type').select2({
        templateResult: formatObstacleOption,
        templateSelection: formatObstacleOption,
        width: '100%'
    });
    
    // If no variations exist, create a default one
    if (config.encounters.length === 0) {
        addNewVariation("Encounter1");
    } else {
        selectVariation(0);
    }
    
    // Update main config fields
    updateMainConfigFields();
}
function formatEnemyOption(enemy) {
    if (!enemy.id) return enemy.text;
    const enemyDef = enemyDictionary.find(e => e.name === enemy.id);
    if (!enemyDef) return enemy.text;
    
    let rankText = "";
    if (enemyDef.ranks.length === 1) {
        rankText = ` (${enemyDef.ranks[0].name})`;
    }
    
    return $(`
        <div class="enemy-option">
            <div class="option-preview" style="background-image: url(enemies/${enemyDef.image})"></div>
            <span>${enemy.text}</span>
        </div>
    `);
}



function formatObstacleOption(obstacle) {
    if (!obstacle.id) return obstacle.text;
    const obstacleDef = obstacleDictionary.find(o => o.name === obstacle.id);
    if (!obstacleDef || !obstacleDef.image) return obstacle.text;
    
    const $option = $(
        `<div class="obstacle-option">
            <div class="option-preview" style="background-image: url(${obstacleDef.image})"></div>
            <span>${obstacle.text}</span>
        </div>`
    );
    return $option;
}
function initializeGrid() {
    const grid = $('#battle-grid');
    grid.empty();
    
    for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 6; col++) {
            const tile = $(`
                <div class="tile" data-row="${row}" data-col="${col}">
                    <div class="tile-bg"></div>
                    <div class="tile-team"></div>
                    <div class="tile-entity"></div>
                </div>
            `);
            
            tile.click(function() {
                selectTile(row, col);
            });
            
            grid.append(tile);
        }
    }
}

function populateEnemyDropdown() {
    const dropdown = $('#enemy-type');
    dropdown.empty();
    
    enemyDictionary.forEach(enemy => {
        if (enemy.nickname === undefined) {
            dropdown.append(`<option value="${enemy.name}">${enemy.name}</option>`);
        } else
        { dropdown.append(`<option value="${enemy.name}">${enemy.nickname}</option>`); }
        
    });
}

function populateObstacleDropdown() {
    const dropdown = $('#obstacle-type');
    dropdown.empty();
    
    obstacleDictionary.forEach((obstacle, index) => {
        if (index > 0) {
            dropdown.append(`<option value="${obstacle.name}">${obstacle.name}</option>`);
        }
    });
}

// =============================================
// Variation Management
// =============================================

function refreshVariationDropdown() {
    const dropdown = $('#variation-select');
    dropdown.empty();
    
    config.encounters.forEach((variation, index) => {
        const name = variation.name || `Scenario ${index + 1}`;
        dropdown.append(`<option value="${index}">${name}</option>`);
    });
    
    dropdown.val(currentVariationIndex);
    $('#delete-variation').prop('disabled', config.encounters.length <= 1);
}

function clearTileSelection() {
    if (selectedTile) {
        $('.tile.selected').removeClass('selected');
        selectedTile = null;
        $('#tile-properties').hide();
        $('#variation-properties').show();
    }
}

function selectVariation(index) {
    if (index >= 0 && index < config.encounters.length) {
        currentVariationIndex = index;
        $('#variation-select').val(index);
        $('#delete-variation').prop('disabled', false);
        
        // Show variation properties
        $('#main-properties').hide();
        $('#variation-properties').show();
        
        // Update fields and grid
        updateVariationFields();
        updateGrid();
        
        // Clear tile selection
        clearTileSelection();
    }
}


function addNewVariation(name) {
        // Ensure name is unique
        let uniqueName = name;
        let counter = 1;
        
        while (config.encounters.some(v => v.name === uniqueName)) {
            uniqueName = `${name} ${counter++}`;
        }
        
        const newVariation = {
            name: uniqueName,
            path: "/server/assets/ezlibs-assets/ezencounters/ezencounters.zip",
            weight: 10,
            enemies: [],
            positions: [
                [0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0]
            ],
            obstacles: [],
            obstacle_positions: [
                [0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0]
            ],
            player_positions: [
                [0, 0, 0, 0, 0, 0],
                [0, 1, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0]
            ],
            tiles: [
                [1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 1]
            ],
            teams: JSON.parse(JSON.stringify(defaultTeamPositions)),
            music: { path: '' },
            results_callback: '',
            freedom_mission: {
                enabled: false,
                turn_count: 5,
                player_can_flip: false
            }
        };
        
        config.encounters.push(newVariation);
        currentVariationIndex = config.encounters.length - 1;
        refreshVariationDropdown();
        selectVariation(currentVariationIndex);
        saveToLocalStorage();
        
        showStatus(`Added new variation: ${uniqueName}`, 'success');
    }

function deleteCurrentVariation() {
    if (config.encounters.length <= 1) {
        showStatus("Cannot delete the last variation", 'error');
        return;
    }
    
    if (confirm("Delete this variation permanently?")) {
        const deletedName = config.encounters[currentVariationIndex].name;
        
        // Clean up before deletion
        cleanupEnemies(config.encounters[currentVariationIndex]);
        
        config.encounters.splice(currentVariationIndex, 1);
        
        // Select another variation
        const newIndex = Math.min(currentVariationIndex, config.encounters.length - 1);
        refreshVariationDropdown();
        selectVariation(newIndex);
        
        saveToLocalStorage();
        showStatus(`Deleted variation: ${deletedName}`, 'success');
    }
}



// =============================================
// Tile and Grid Management
// =============================================

function selectTile(row, col) {
    // Deselect if clicking the same tile
    if (selectedTile && selectedTile.row === row && selectedTile.col === col) {
        clearTileSelection();
        return;
    }
    
    // Select new tile
    $('.tile.selected').removeClass('selected');
    selectedTile = { row, col };
    $(`.tile[data-row="${row}"][data-col="${col}"]`).addClass('selected');
    $('#tile-properties').show();
    $('#variation-properties').hide();
    
    updateTileFields();

    if (selectedTile) {
    const variation = config.encounters[currentVariationIndex];
    cleanupEnemies(variation);          
    }
}

function cleanupEnemies(variation) {
    // Collect all enemy indices currently in use
    const usedIndices = new Set();
    for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 6; col++) {
            const index = variation.positions[row][col];
            if (index > 0) {
                usedIndices.add(index);
            }
        }
    }

    // If all enemies are used, no cleanup needed
    if (usedIndices.size === (variation.enemies?.length || 0)) {
        return;
    }

    // Create new arrays for cleaned enemies and position mapping
    const newEnemies = [];
    const indexMap = {};
    let newIndex = 1;

    // Build new enemies array and mapping
    variation.enemies?.forEach((enemy, oldIndex) => {
        const actualIndex = oldIndex + 1;
        if (usedIndices.has(actualIndex)) {
            newEnemies.push(enemy);
            indexMap[actualIndex] = newIndex++;
        }
    });

    // Update positions with new indices
    for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 6; col++) {
            const oldIndex = variation.positions[row][col];
            if (oldIndex > 0 && indexMap[oldIndex]) {
                variation.positions[row][col] = indexMap[oldIndex];
            } else if (oldIndex > 0) {
                variation.positions[row][col] = 0; // Clear invalid references
            }
        }
    }

    // Update the variation
    variation.enemies = newEnemies;
    
    // Add this line to immediately reflect changes
    updateGrid();
}


function formatRankOption(rank) {
    if (!rank.id) return rank.text;
    
    const enemyName = $('#enemy-type').val();
    const enemy = enemyDictionary.find(e => e.name === enemyName);
    if (!enemy) return rank.text;
    
    const rankInfo = enemy.ranks.find(r => r.value == rank.id);
    const rankName = rankInfo ? rankInfo.name : `Rank ${rank.id}`;
    const imagePath = $(rank.element).data('image');
    
    return $(`
        <div class="rank-option">
            <div class="option-preview" style="background-image: url(${imagePath})"></div>
            <div>
                <div>${rankName}</div>
               <!--<small>Rank ${rank.id}</small>-->
            </div>
        </div>
    `);
}

function updateEnemyRankPreview(enemyName, rank) {
    const preview = $('#enemy-rank-preview');
    const imagePath = getEnemyImage(enemyName, rank);
    if (imagePath) {
        preview.css('background-image', `url(${imagePath})`);
    } else {
        preview.css('background-image', 'none');
    }
}
function updateEnemyRankOptions(enemyName) {
    const rankSelect = $('#enemy-rank');
    const rankContainer = rankSelect.closest('label');
    
    rankSelect.empty();
    
    const enemy = enemyDictionary.find(e => e.name === enemyName);
    if (!enemy) return;
    
    // Add available ranks with their display names
    enemy.ranks.forEach(rank => {
        const imagePath = getEnemyImage(enemyName, rank.value);
        rankSelect.append(
            `<option value="${rank.value}" data-image="${imagePath}">
                ${rank.name} (Rank ${rank.value})
             </option>`
        );
    });
    
    // Show/hide based on number of ranks
    if (enemy.ranks.length <= 1) {
        rankContainer.hide();
        if (enemy.ranks.length === 1) {
            rankSelect.val(enemy.ranks[0].value).trigger('change');
        }
    } else {
        rankContainer.show();
    }
    
    // Reinitialize Select2 if needed
    if (rankSelect.hasClass('select2-hidden-accessible')) {
        rankSelect.select2('destroy');
    }
    
    if (enemy.ranks.length > 1) {
        rankSelect.select2({
            templateResult: formatRankOption,
            templateSelection: formatRankOption,
            width: '100%'
        });
    }
    
    if (enemy.ranks.length > 0) {
        rankSelect.val(enemy.ranks[0].value).trigger('change');
    }
}




function updateGrid() {
    if (currentVariationIndex === -1 || currentVariationIndex >= config.encounters.length) return;
    
    const variation = config.encounters[currentVariationIndex];
    
    // Ensure all required arrays exist
    if (!variation.positions) variation.positions = defaultTeamPositions.map(row => [...row]);
    if (!variation.tiles) variation.tiles = Array(3).fill().map(() => Array(6).fill(1));
    if (!variation.teams) variation.teams = defaultTeamPositions.map(row => [...row]);
    if (!variation.obstacle_positions) variation.obstacle_positions = Array(3).fill().map(() => Array(6).fill(0));
    if (!variation.player_positions) variation.player_positions = Array(3).fill().map(() => Array(6).fill(0));
    
    for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 6; col++) {
            updateTileImage(row, col);
        }
    }
}

function getEnemyImage(enemyName, rank) {
    const enemy = enemyDictionary.find(e => e.name === enemyName);
    if (!enemy) return '';
    
    // Check for rank-specific image first
    if (enemy.rankImages && enemy.rankImages[rank]) {
        return "enemies/"+enemy.rankImages[rank];
    }
    
    // Fall back to default image
    return "enemies/"+enemy.image;
}

function updateTileImage(row, col) {
    const tile = $(`.tile[data-row="${row}"][data-col="${col}"]`);
    const variation = config.encounters[currentVariationIndex];
    
    // Clear existing images
    tile.find('.tile-bg, .tile-team, .tile-entity').css({
        'background-image': 'none',
        'background-position': '0 0'
    });
    
    // Update tile background
    const tileType = variation.tiles[row][col] || 1;
    const tileDef = tileDictionary[tileType];
    if (tileDef?.image) {
        tile.find('.tile-bg').css({
            'background-image': `url(${tileDef.image})`,
            'background-position': `${tileDef.offsetX || 0}px ${tileDef.offsetY || 0}px`
        });
    }
    
    // Update team overlay
    const teamValue = variation.teams ? variation.teams[row][col] : defaultTeamPositions[row][col];
    const teamDef = teamDictionary[teamValue];
    if (teamDef?.image) {
        tile.find('.tile-team').css({
            'background-image': `url(${teamDef.image})`,
            'background-position': `${teamDef.offsetX || 0}px ${teamDef.offsetY || 0}px`
        });
    }
    
    // Update entity (enemy, obstacle, or player)
    const enemyIndex = variation.positions[row][col];
    const obstacleValue = variation.obstacle_positions ? variation.obstacle_positions[row][col] : 0;
    const playerValue = variation.player_positions ? variation.player_positions[row][col] : 0;
    
    if (enemyIndex > 0 && variation.enemies && enemyIndex <= variation.enemies.length) {
        const enemy = variation.enemies[enemyIndex - 1];
        const enemyDef = enemyDictionary.find(e => e.name === enemy.name);
        if (enemyDef) {
            const imagePath = getEnemyImage(enemy.name, enemy.rank || 1);
            if (imagePath) {
                tile.find('.tile-entity').css({
                    'background-image': `url(${imagePath})`,
                    'background-position': `${enemyDef.offsetX || 0}px ${enemyDef.offsetY || 0}px`,
                    'transform': teamValue === 2 ? 'scaleX(-1)' : 'none' // Add this line
                });
            }
        }
    } else if (obstacleValue > 0 && variation.obstacles && obstacleValue <= variation.obstacles.length) {
        const obstacle = variation.obstacles[obstacleValue - 1];
        const obstacleDef = obstacleDictionary.find(o => o.name === obstacle.name);
        if (obstacleDef?.image) {
            tile.find('.tile-entity').css({
                'background-image': `url(${obstacleDef.image})`,
                'background-position': `${obstacleDef.offsetX || 0}px ${obstacleDef.offsetY || 0}px`
            });
        }
    } else if (playerValue > 0) {
        const playerDef = playerDictionary.player;
        if (playerDef?.image) {
            tile.find('.tile-entity').css({
                'background-image': `url(${playerDef.image})`,
                'background-position': `${playerDef.offsetX || 0}px ${playerDef.offsetY || 0}px`,
                'transform': teamValue === 1 ? 'scaleX(-1)' : 'none' // Flip player on blue team
            });
        }
    }
}


// =============================================
// Field Updates
// =============================================

function updateMainConfigFields() {
    $('#min-steps').val(config.minimum_steps_before_encounter);
    $('#encounter-chance').val(config.encounter_chance_per_step);
}

function updateVariationFields() {
    if (currentVariationIndex === -1 || currentVariationIndex >= config.encounters.length) return;
    
    const variation = config.encounters[currentVariationIndex];
    $('#variation-weight').val(variation.weight || 10);
    $('#music-path').val(variation.music?.path || '');
    $('#results-callback').val(variation.results_callback || '');
    
    // Freedom mission options
    const freedomMission = variation.freedom_mission || { enabled: false, turn_count: 5, player_can_flip: false };
    $('#freedom-mission').prop('checked', freedomMission.enabled);
    $('#freedom-mission-options').toggle(freedomMission.enabled);
    $('#turn-count').val(freedomMission.turn_count);
    $('#player-can-flip').prop('checked', freedomMission.player_can_flip);
}

function updateTileFields() {
    if (!selectedTile || currentVariationIndex === -1 || currentVariationIndex >= config.encounters.length) {
        $('#tile-properties').hide();
        return;
    }
    
    const variation = config.encounters[currentVariationIndex];
    const { row, col } = selectedTile;
    
    // Ensure arrays exist
    if (!variation.obstacles) variation.obstacles = Array();
    if (!variation.tiles) variation.tiles = Array(3).fill().map(() => Array(6).fill(1));
    if (!variation.teams) variation.teams = defaultTeamPositions.map(row => [...row]);
    if (!variation.positions) variation.positions = Array(3).fill().map(() => Array(6).fill(0));
    if (!variation.obstacle_positions) variation.obstacle_positions = Array(3).fill().map(() => Array(6).fill(0));
    if (!variation.player_positions) variation.player_positions = Array(3).fill().map(() => Array(6).fill(0));
    
    // Get current tile state
    const tileType = variation.tiles[row][col] || 1;
    const teamValue = variation.teams[row][col];
    const enemyIndex = variation.positions[row][col];
    const obstacleValue = variation.obstacle_positions[row][col];
    const playerValue = variation.player_positions[row][col];
    
    // Set tile type and team
    $('#tile-type').val(tileType);
    $('#tile-team').val(teamValue);
    
    // Set content type
    if (enemyIndex > 0 && variation.enemies && enemyIndex <= variation.enemies.length) {
        $('#content-type').val('enemy');
        $('#enemy-properties').show();
        $('#obstacle-properties').hide();
        
        const enemy = variation.enemies[enemyIndex - 1];
        if (enemy) {
            $('#enemy-type').val(enemy.name).trigger('change');
            $('#enemy-rank').val(enemy.rank || 1).trigger('change');
            $('#enemy-nickname').val(enemy.nickname || '');
        }
    } else if (obstacleValue > 0 && variation.obstacles && obstacleValue <= variation.obstacles.length) {
        $('#content-type').val('obstacle');
        $('#enemy-properties').hide();
        $('#obstacle-properties').show();
        
        const obstacle = variation.obstacles[obstacleValue - 1];
        if (obstacle) {
            $('#obstacle-type').val(obstacle.name);
        }
    } else if (playerValue > 0) {
        $('#content-type').val('player');
        $('#enemy-properties').hide();
        $('#obstacle-properties').hide();
    } else {
        $('#content-type').val('none');
        $('#enemy-properties').hide();
        $('#obstacle-properties').hide();
    }
}


// =============================================
// Event Handlers
// =============================================

function setupEventHandlers() {
        $('#download-mods').change(function() {
            if ($(this).is(':checked')) {
                showDownloadInfoModal();
            }
        });
        // Toolbar buttons
        $('#new-config').click(function() {
            if (confirm("Create new configuration? Current changes will be lost.")) {
                config = {
                    minimum_steps_before_encounter: 80,
                    encounter_chance_per_step: 0.05,
                    encounters: []
                };
                addNewVariation("Encounter1");
                saveToLocalStorage();
                showStatus("Created new configuration", 'success');
            }
        });
        
        $('#load-config').click(function() {
            $('#load-file').click();
        });
        
        $('#save-config').click(function() {
            saveToFile();
        });
        
        $('#clear-all').click(function() {
            if (confirm("Clear all settings and return to defaults?")) {
                // Clear localStorage
                localStorage.removeItem('battleConfig');
                localStorage.removeItem('luaPreservedContent');
                
                // Reset config
                config = {
                    minimum_steps_before_encounter: 80,
                    encounter_chance_per_step: 0.05,
                    encounters: []
                };
                
                // Clear file input
                $('#load-file').val('');
                
                // Reset UI
                addNewVariation("Encounter1");
                saveToLocalStorage();
                showStatus("Reset to default configuration", 'success');
            }
        });
        
        $('#add-variation').click(function() {
            const name = prompt("Enter a name for the new scenario:");
            const nameWithoutSpaces = name.replace(/\s/g, "");

            if (nameWithoutSpaces) {
                addNewVariation(nameWithoutSpaces);
            }
        });
        
        $('#delete-variation').click(function() {
            // Add this at the start:
            if (currentVariationIndex >= 0) {
                cleanupEnemies(config.encounters[currentVariationIndex]);
            }
            deleteCurrentVariation();
        });
        
        $('#variation-select').change(function() {
            selectVariation(parseInt($(this).val()));
        });
        
        // Main config fields
        $('#min-steps').change(function() {
            config.minimum_steps_before_encounter = parseInt($(this).val()) || 0;
            saveToLocalStorage();
        });
        
        $('#encounter-chance').change(function() {
            let value = parseFloat($(this).val()) || 0;
            value = Math.max(0, Math.min(1, value));
            $(this).val(value);
            config.encounter_chance_per_step = value;
            saveToLocalStorage();
        });
        
        // Variation fields
        $('#variation-weight').change(function() {
            if (currentVariationIndex === -1) return;
            config.encounters[currentVariationIndex].weight = parseInt($(this).val()) || 0;
            saveToLocalStorage();
        });
        
        $('#music-path').change(function() {
            if (currentVariationIndex === -1) return;
            config.encounters[currentVariationIndex].music.path = $(this).val();
            saveToLocalStorage();
        });
        
        $('#results-callback').change(function() {
            if (currentVariationIndex === -1) return;
            config.encounters[currentVariationIndex].results_callback = $(this).val();
            saveToLocalStorage();
        });
        
        // Freedom mission toggle
        $('#freedom-mission').change(function() {
            if (currentVariationIndex === -1) return;
            const enabled = $(this).is(':checked');
            config.encounters[currentVariationIndex].freedom_mission.enabled = enabled;
            $('#freedom-mission-options').toggle(enabled);
            saveToLocalStorage();
        });
        
        // Freedom mission options
        $('#turn-count').change(function() {
            if (currentVariationIndex === -1) return;
            config.encounters[currentVariationIndex].freedom_mission.turn_count = parseInt($(this).val()) || 5;
            saveToLocalStorage();
        });
        
        $('#player-can-flip').change(function() {
            if (currentVariationIndex === -1) return;
            config.encounters[currentVariationIndex].freedom_mission.player_can_flip = $(this).is(':checked');
            saveToLocalStorage();
        });
        
        // Tile fields
        $('#tile-type').change(function() {
            if (!selectedTile || currentVariationIndex === -1) return;
            const value = parseInt($(this).val()) || 1;
            config.encounters[currentVariationIndex].tiles[selectedTile.row][selectedTile.col] = value;
            updateTileImage(selectedTile.row, selectedTile.col);
            saveToLocalStorage();
        });
        
        $('#tile-team').change(function() {
            if (!selectedTile || currentVariationIndex === -1) return;
            const value = parseInt($(this).val()) || 0;
            const variation = config.encounters[currentVariationIndex];
            
            // Initialize teams array if it doesn't exist
            if (!variation.teams) {
                variation.teams = JSON.parse(JSON.stringify(defaultTeamPositions));
            }
            
            variation.teams[selectedTile.row][selectedTile.col] = value;
            
            // If changing to blue team and player is present, remove player
            /*
            if (value === 1 && variation.player_positions[selectedTile.row][selectedTile.col] > 0) {
                variation.player_positions[selectedTile.row][selectedTile.col] = 0;
                $('#content-type').val('none');
                $('#enemy-properties').hide();
                $('#obstacle-properties').hide();
            }
            */
            
            updateTileImage(selectedTile.row, selectedTile.col);
            saveToLocalStorage();
        });
        
        $('#content-type').change(function() {
            if (!selectedTile || currentVariationIndex === -1) return;
            
            const type = $(this).val();
            const variation = config.encounters[currentVariationIndex];
            const { row, col } = selectedTile;
            
            // Clear existing content
            variation.positions[row][col] = 0;
            variation.obstacle_positions[row][col] = 0;
            variation.player_positions[row][col] = 0;
            
            // Show appropriate properties
            if (type === 'enemy') {
                $('#enemy-properties').show();
                $('#obstacle-properties').hide();
                const firstEnemy = enemyDictionary[0].name;
                $('#enemy-type').val(firstEnemy).trigger('change');
                updateEnemyOnTile();

            } else if (type === 'obstacle') {
                $('#enemy-properties').hide();
                $('#obstacle-properties').show();
                const firstObstacle = obstacleDictionary[1].name; // Skip "None"
                $('#obstacle-type').val(firstObstacle).trigger('change');
                updateObstacleOnTile();

            } else if (type === 'player') {
                $('#enemy-properties').hide();
                $('#obstacle-properties').hide();
                variation.player_positions[row][col] = 1;
            } else {
                $('#enemy-properties').hide();
                $('#obstacle-properties').hide();
            }
            
            updateTileImage(row, col);
            cleanupEnemies(config.encounters[currentVariationIndex]);
            updateGrid();
            saveToLocalStorage();
        });
        
        // Enemy properties
        $('#enemy-type').change(function() {
            const enemyName = $(this).val();
            updateEnemyRankOptions(enemyName);
            updateEnemyOnTile();
        });

        $('#enemy-rank').change(updateEnemyOnTile);
        $('#enemy-nickname').change(updateEnemyOnTile);
        
        // Obstacle properties
        $('#obstacle-type').change(updateObstacleOnTile);
        
        // File input for loading

        $('<input type="file" id="load-file" style="display:none;">').change(function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const luaConfig = parseLuaConfig(content);
                    
                    if (!luaConfig) throw new Error("Failed to parse config");

                    // Initialize default config structure
                    const defaultConfig = {
                        minimum_steps_before_encounter: 80,
                        encounter_chance_per_step: 0.05,
                        encounters: []
                    };

                    // Merge with loaded config
                    config = { ...defaultConfig, ...luaConfig };

                    // Ensure encounters is an array
                    if (!Array.isArray(config.encounters)) {
                        config.encounters = [];
                    }

                    // Process each encounter
                    config.encounters = config.encounters.map(encounter => {
                        const defaultEncounter = {
                            name: "Unnamed Encounter",
                            path: "/server/assets/ezlibs-assets/ezencounters/ezencounters.zip",
                            weight: 10,
                            enemies: [],
                            positions: Array(3).fill().map(() => Array(6).fill(0)),
                            obstacles: [],
                            obstacle_positions: Array(3).fill().map(() => Array(6).fill(0)),
                            player_positions: Array(3).fill().map(() => Array(6).fill(0)),
                            tiles: Array(3).fill().map(() => Array(6).fill(1)),
                            teams: JSON.parse(JSON.stringify(defaultTeamPositions)),
                            music: { path: '' },
                            results_callback: '',
                            freedom_mission: {
                                enabled: false,
                                turn_count: 5,
                                player_can_flip: false
                            }
                        };

                        // Deep merge with loaded encounter
                        const merged = { ...defaultEncounter, ...encounter };

                        // Ensure enemies is properly formatted
                        if (!Array.isArray(merged.obstacles)) {
                            merged.obstacles = [];
                        } else {
                            merged.obstacles = merged.obstacles.filter(e => e && typeof e === 'object');
                        }
                        if (!Array.isArray(merged.enemies)) {
                            merged.enemies = [];
                        } else {
                            merged.enemies = merged.enemies.filter(e => e && typeof e === 'object');
                        }

                        // Ensure all arrays have correct dimensions
                        const ensureGrid = (grid, defaultValue = 0) => {
                            if (!Array.isArray(grid)) return Array(3).fill().map(() => Array(6).fill(defaultValue));
                            return grid.map(row => {
                                if (!Array.isArray(row)) return Array(6).fill(defaultValue);
                                return [...row, ...Array(Math.max(0, 6 - row.length)).fill(defaultValue)].slice(0, 6);
                            }).slice(0, 3);
                        };

                        merged.positions = ensureGrid(merged.positions, 0);
                        merged.obstacle_positions = ensureGrid(merged.obstacle_positions, 0);
                        merged.player_positions = ensureGrid(merged.player_positions, 0);
                        merged.tiles = ensureGrid(merged.tiles, 1);
                        merged.teams = ensureGrid(merged.teams, 0);

                        return merged;
                    });

                    // Reset UI state
                    selectedTile = null;
                    currentVariationIndex = -1;

                    // Update UI components
                    initializeGrid();
                    refreshVariationDropdown();
                    populateEnemyDropdown();
                    populateObstacleDropdown();
                    
                    if (config.encounters.length > 0) {
                        selectVariation(0);
                    } else {
                        $('#variation-properties').hide();
                        $('#main-properties').show();
                    }

                    updateMainConfigFields();
                    saveToLocalStorage();
                    
                    // Clear file input
                    $(this).val('');
                    
                    showStatus("Configuration loaded successfully", 'success');
                } catch (err) {
                    showStatus("Error loading file: " + err.message, 'error');
                    console.error("Import error:", err);
                }
            };
            reader.readAsText(file);
        }).appendTo('body');
}


function updateEnemyOnTile() {
    if (!selectedTile || currentVariationIndex === -1) return;
    
    const variation = config.encounters[currentVariationIndex];
    const { row, col } = selectedTile;
    
    // Get enemy properties
    const name = $('#enemy-type').val();
    //const rank = parseInt($('#enemy-rank').val()) || 1;
    const rank = parseInt($('#enemy-rank').val()) || enemy.ranks[0].value;

    const nickname = $('#enemy-nickname').val();
    
    // First check if an identical enemy already exists
    let enemyIndex = -1;
    if (variation.enemies) {
        enemyIndex = variation.enemies.findIndex(e => 
            e.name === name && e.rank === rank
        );
    }

    // Create or update enemy
    const enemy = { name, rank };
    if (nickname) enemy.nickname = nickname;
    
    if (enemyIndex >= 0) {
        // Update existing enemy (preserve any additional properties)
        variation.enemies[enemyIndex] = { ...variation.enemies[enemyIndex], ...enemy };
        variation.positions[row][col] = enemyIndex + 1; // +1 because positions are 1-based
    } else {
        // Add new enemy
        if (!variation.enemies) variation.enemies = [];
        variation.enemies.push(enemy);
        variation.positions[row][col] = variation.enemies.length;
    }
    
    // Clear other content types
    variation.obstacle_positions[row][col] = 0;
    variation.player_positions[row][col] = 0;
    
    cleanupEnemies(variation);
    updateTileImage(row, col);
    saveToLocalStorage();
}


function updateObstacleOnTile() {
        if (!selectedTile || currentVariationIndex === -1) return;
        
        const variation = config.encounters[currentVariationIndex];
        const { row, col } = selectedTile;
        const name = $('#obstacle-type').val();
        
        // Create or update obstacle
        const obstacle = { name };
        
        // Check if we're updating an existing obstacle
        const existingIndex = variation.obstacle_positions[row][col] - 1;
        if (existingIndex >= 0 && existingIndex < variation.obstacles.length) {
            variation.obstacles[existingIndex] = obstacle;
        } else {
            // Add new obstacle
            variation.obstacles.push(obstacle);
            variation.obstacle_positions[row][col] = variation.obstacles.length;
            variation.positions[row][col] = 0;
            variation.player_positions[row][col] = 0;
        }
        
        updateTileImage(row, col);
        cleanupEnemies(variation);
        saveToLocalStorage();
        
    }

// =============================================
// Event Handlers for Tile Properties
// =============================================


function setupTilePropertyHandlers() {
    // Tile type change
    $('#tile-type').change(function() {
        if (!selectedTile || currentVariationIndex === -1) return;
        const value = parseInt($(this).val()) || 1;
        const variation = config.encounters[currentVariationIndex];
        
        // Initialize tiles array if it doesn't exist
        if (!variation.tiles) {
            variation.tiles = Array(3).fill().map(() => Array(6).fill(1));
        }
        
        variation.tiles[selectedTile.row][selectedTile.col] = value;
        updateTileImage(selectedTile.row, selectedTile.col);
        saveToLocalStorage();
    });
    
    // Team change
    $('#tile-team').change(function() {
        if (!selectedTile || currentVariationIndex === -1) return;
        const value = parseInt($(this).val()) || 0;
        const variation = config.encounters[currentVariationIndex];
        
        // Initialize teams array if it doesn't exist
        if (!variation.teams) {
            variation.teams = JSON.parse(JSON.stringify(defaultTeamPositions));
        }
        
        variation.teams[selectedTile.row][selectedTile.col] = value;
        
        // If changing to blue team and player is present, remove player
        if (value === 1 && variation.player_positions[selectedTile.row][selectedTile.col] > 0) {
            variation.player_positions[selectedTile.row][selectedTile.col] = 0;
            $('#content-type').val('none').trigger('change');
        }
        
        updateTileImage(selectedTile.row, selectedTile.col);
        saveToLocalStorage();
    });
    
    // Content type change
    $('#content-type').change(function() {
        if (!selectedTile || currentVariationIndex === -1) return;
        
        const type = $(this).val();
        const variation = config.encounters[currentVariationIndex];
        const { row, col } = selectedTile;
        
        // Initialize arrays if they don't exist
        if (!variation.positions) variation.positions = Array(3).fill().map(() => Array(6).fill(0));
        if (!variation.obstacle_positions) variation.obstacle_positions = Array(3).fill().map(() => Array(6).fill(0));
        if (!variation.player_positions) variation.player_positions = Array(3).fill().map(() => Array(6).fill(0));
        
        // Clear existing content
        variation.positions[row][col] = 0;
        variation.obstacle_positions[row][col] = 0;
        variation.player_positions[row][col] = 0;
        
        // Handle the new content type
        if (type === 'player') {
            // Only allow player on red team tiles
            const teamValue = variation.teams ? variation.teams[row][col] : defaultTeamPositions[row][col];
            if (teamValue !== 2) {
                showStatus("Player can only be placed on red team tiles", 'error');
                $(this).val('none').trigger('change');
                return;
            }
             // Remove player from any other tiles first
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 6; c++) {
                    if (variation.player_positions[r][c] > 0) {
                        variation.player_positions[r][c] = 0;
                        updateTileImage(r, c); // Update the visual grid
                    }
                }
            }
            variation.player_positions[row][col] = 1;
        }
        
        updateTileImage(row, col);
        saveToLocalStorage();
    });
    
    // Enemy properties changes
    $('#enemy-type, #enemy-rank, #enemy-nickname').change(function() {
        if (!selectedTile || currentVariationIndex === -1) return;
        
        const variation = config.encounters[currentVariationIndex];
        const { row, col } = selectedTile;
        
        // Get enemy properties
        const name = $('#enemy-type').val();
        //const rank = parseInt($('#enemy-rank').val()) || 1;
        const rank = parseInt($('#enemy-rank').val()) || enemy.ranks[0].value;

        const nickname = $('#enemy-nickname').val();
        
        // Create or update enemy
        const enemy = { name, rank };
        if (nickname) enemy.nickname = nickname;
        
        // Check if we're updating an existing enemy
        const enemyIndex = variation.positions[row][col] - 1;
        if (enemyIndex >= 0 && enemyIndex < variation.enemies.length) {
            variation.enemies[enemyIndex] = enemy;
        } else {
            // Add new enemy
            if (!variation.enemies) variation.enemies = [];
            variation.enemies.push(enemy);
            variation.positions[row][col] = variation.enemies.length;
            variation.obstacle_positions[row][col] = 0;
            variation.player_positions[row][col] = 0;
        }
        
        updateTileImage(row, col);
        saveToLocalStorage();
    });
    
    // Obstacle properties changes
    $('#obstacle-type').change(function() {
        if (!selectedTile || currentVariationIndex === -1) return;
        
        const variation = config.encounters[currentVariationIndex];
        const { row, col } = selectedTile;
        const name = $('#obstacle-type').val();
        
        // Create or update obstacle
        const obstacle = { name };
        
        // Check if we're updating an existing obstacle
        const obstacleIndex = variation.obstacle_positions[row][col] - 1;
        if (obstacleIndex >= 0 && obstacleIndex < variation.obstacles.length) {
            variation.obstacles[obstacleIndex] = obstacle;
        } else {
            // Add new obstacle
            if (!variation.obstacles) variation.obstacles = [];
            variation.obstacles.push(obstacle);
            variation.obstacle_positions[row][col] = variation.obstacles.length;
            variation.positions[row][col] = 0;
            variation.player_positions[row][col] = 0;
        }
        
        updateTileImage(row, col);
        saveToLocalStorage();
    });
}



// =============================================
// Storage and File Handling
// =============================================


function saveToLocalStorage() {
    localStorage.setItem('battleConfig', JSON.stringify(config));
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem('battleConfig');
    if (saved) {
        try {
            config = JSON.parse(saved);
            
            // Ensure all variations have required fields

            if (!Array.isArray(config.encounters)) {
                config.encounters = [];
            }

            if (config.encounters) {
                config.encounters.forEach(variation => {
                    if (!variation.teams) {
                        variation.teams = JSON.parse(JSON.stringify(defaultTeamPositions));
                    }
                    if (!variation.player_positions) {
                        variation.player_positions = [
                            [0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0]
                        ];
                    }
                    if (!variation.results_callback) {
                        variation.results_callback = '';
                    }
                    if (!variation.freedom_mission) {
                        variation.freedom_mission = {
                            enabled: false,
                            turn_count: 5,
                            player_can_flip: false
                        };
                    }
                });
            }
        } catch (e) {
            console.error("Error loading from local storage", e);
            config = {
                minimum_steps_before_encounter: 80,
                encounter_chance_per_step: 0.05,
                encounters: []
            };
        }
    }
}

async function saveToFile() {
    try {
        // Convert config to Lua string
        const luaString = generateLuaString();
        
        // Create download link for config
        const blob = new Blob([luaString], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'battle_config.lua';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Download mod files if enabled
        await downloadModFiles();
        
        showStatus("Configuration saved successfully", 'success');
    } catch (err) {
        console.error('Error saving files:', err);
        showStatus("Error saving files: " + err.message, 'error');
    }
}


// =============================================
// Lua Generation Functions
// =============================================

function extractNonConfigContent(luaString) {
    const preserved = {
        comments: [],
        functions: [],
        other: []
    };

    // Remove the return statement and everything after it
    const withoutReturn = luaString.split(/return\s*{[\s\S]*?}\s*$/)[0];
    
    // Extract comments
    preserved.comments = withoutReturn.match(/--.*$/gm) || [];
    
    // Extract function definitions
    preserved.functions = withoutReturn.match(/function\s+[\w\.]+\s*\([^)]*\)[\s\S]*?end/g) || [];
    
    // Extract other non-local content
    const otherContent = withoutReturn
        .replace(/--.*$/gm, '') // Remove comments
        .replace(/function\s+[\w\.]+\s*\([^)]*\)[\s\S]*?end/g, '') // Remove functions
        .replace(/local\s+\w+\s*=\s*{[\s\S]*?}(?=\s*(?:local|function|$))/g, ''); // Remove local vars
    
    preserved.other = otherContent.split('\n')
        .filter(line => line.trim().length > 0 && !line.match(/^\s*local\s/));
    
    return preserved;
}


function parseLuaConfig(luaString) {
    if (DEBUG_MODE) console.log("Starting to parse Lua config...");
    
    try {
        // First extract preserved content (comments, functions, etc.)
        const preserved = extractNonConfigContent(luaString);
        localStorage.setItem('luaPreservedContent', JSON.stringify(preserved));
        
        if (DEBUG_MODE) console.log("Preserved content extracted:", preserved);
        
        // Then parse the actual config content
        const config = parseConfigContent(luaString);
        
        if (DEBUG_MODE) console.log("Successfully parsed Lua config:", config);
        return config;
    } catch (e) {
        if (DEBUG_MODE) console.error("Error parsing Lua config:", e);
        showStatus(`Error parsing config: ${e.message}`, 'error');
        return null;
    }
}

function parseLuaTable(luaTableStr) {
    if (DEBUG_MODE) console.log("Parsing Lua table:", luaTableStr);
    
    try {
        // Clean up the string first
        let cleaned = luaTableStr.trim();
        
        // Remove outer curly braces if present
        if (cleaned.startsWith('{') && cleaned.endsWith('}')) {
            cleaned = cleaned.slice(1, -1).trim();
        }
        
        if (DEBUG_MODE) console.log("Cleaned table string:", cleaned);
        
        // Handle empty table
        if (!cleaned) {
            if (DEBUG_MODE) console.log("Empty table - returning empty object");
            return {};
        }
        
        // Initialize result object
        const result = {};
        const arrayResult = [];
        let isArray = true;
        
        // Split into key-value pairs
        const pairs = splitLuaTableEntries(cleaned);
        
        if (DEBUG_MODE) console.log("Found pairs:", pairs);
        
        pairs.forEach((pair, index) => {
            // Special handling for enemies array
            if (pair.trim().startsWith('enemies={')) {
                isArray = false;
                //const enemiesStr = pair.match(/enemies=\s*({.*})/)[0];
                const enemiesStr = pair
                console.log(pair)
                result.enemies = parseLuaEnemies(enemiesStr);
                return;
            }
            console.log("THE PAIR: ",pair)
            if (pair.trim().startsWith('obstacles={')) {
                isArray = false;
                //const enemiesStr = pair.match(/enemies=\s*({.*})/)[0];
                const obstaclesStr = pair
                console.log(pair)
                result.obstacles = parseLuaObstacles(obstaclesStr);
                return;
            }
            
            // Special handling for freedom_mission
            if (pair.trim().startsWith('freedom_mission={')) {
                isArray = false;
                //const fmStr = pair.match(/freedom_mission=\s*({.*})/)[1];
                const fmStr = pair
                result.freedom_mission = parseLuaFreedomMission(fmStr);
                return;
            }
            
            // Special handling for music
            if (pair.trim().startsWith('music={')) {
                isArray = false;
                //const musicStr = pair.match(/music=\s*({.*})/)[1];
                const musicStr = pair
                result.music = parseLuaMusic(musicStr);
                return;
            }
            
            // Handle array-like entries (no key specified)
            if (!pair.includes('=')) {
                const value = parseLuaValue(pair.trim());
                arrayResult.push(value);
                result[index + 1] = value; // Lua arrays are 1-based
                return;
            }
            
            // Handle key-value pairs
            isArray = false;
            const [keyStr, valueStr] = pair.split('=').map(s => s.trim());
            const key = parseLuaKey(keyStr);
            const value = parseLuaValue(valueStr);
            
            if (DEBUG_MODE) console.log(`Processing pair: ${keyStr}=${valueStr} ->`, {key, value});
            
            result[key] = value;
        });
        
        // Return as array if it appears to be one
        const finalResult = isArray ? arrayResult : result;
        
        if (DEBUG_MODE) console.log("Final parsed table:", finalResult);
        return finalResult;
    } catch (e) {
        if (DEBUG_MODE) console.error("Error parsing Lua table:", e);
        throw e;
    }
}

// Special parser for enemies array
function parseLuaEnemies(enemiesStr) {
    if (DEBUG_MODE) console.log("Parsing enemies:", enemiesStr);
    
    const enemies = [];
    //const cleaned = enemiesStr.trim().slice(0, -1).trim(); // Remove outer {}
    const cleaned = enemiesStr.replace("\n    }","").replace("enemies={\n","")
    console.log("CLEANED? ",cleaned)
    if (!cleaned) return enemies;
    
    const enemyEntries = splitLuaTableEntries(cleaned);
    
    enemyEntries.forEach(entry => {
        if (DEBUG_MODE) console.log("Parsing enemy entry:", entry);
        
        const enemy = {};
        const props = entry.trim().slice(1, -1).split(',').map(p => p.trim());
        
        props.forEach(prop => {
            if (!prop) return;
            const [key, value] = prop.split('=').map(s => s.trim());
            if (key && value) {
                enemy[key] = parseLuaValue(value);
            }
        });
        
        if (Object.keys(enemy).length > 0) {
            enemies.push(enemy);
        }
    });
    
    if (DEBUG_MODE) console.log("Parsed enemies:", enemies);
    return enemies;
}
function parseLuaObstacles(obstaclesStr) {
    if (DEBUG_MODE) console.log("Parsing obstacles:", obstaclesStr);
    
    const obstacles = [];
    const cleaned = obstaclesStr.replace("\n    }","").replace("obstacles={\n","")
    console.log("CLEANED? ",cleaned)
    if (!cleaned) return obstacles;
    
    const enemyEntries = splitLuaTableEntries(cleaned);
    
    enemyEntries.forEach(entry => {
        if (DEBUG_MODE) console.log("Parsing enemy entry:", entry);
        
        const enemy = {};
        const props = entry.trim().slice(1, -1).split(',').map(p => p.trim());
        
        props.forEach(prop => {
            if (!prop) return;
            const [key, value] = prop.split('=').map(s => s.trim());
            if (key && value) {
                enemy[key] = parseLuaValue(value);
            }
        });
        
        if (Object.keys(enemy).length > 0) {
            obstacles.push(enemy);
        }
    });
    
    if (DEBUG_MODE) console.log("Parsed obstacles:", obstacles);
    return obstacles;
}

// Special parser for freedom_mission
function parseLuaFreedomMission(fmStr) {
    if (DEBUG_MODE) console.log("Parsing freedom_mission:", fmStr);
    
    const fm = {
        enabled: false,
        turn_count: 5,
        player_can_flip: false
    };
    
    //const cleaned = fmStr.trim().slice(1, -1).trim(); // Remove outer {}
    const cleaned = fmStr.replace("\n    }","").replace("freedom_mission={\n","")

    if (!cleaned) return fm;
    
    const props = splitLuaTableEntries(cleaned);
    
    props.forEach(prop => {
        if (!prop) return;
        const [key, value] = prop.split('=').map(s => s.trim());
        if (key && value) {
            fm[key] = parseLuaValue(value);
        }
    });
    
    if (DEBUG_MODE) console.log("Parsed freedom_mission:", fm);
    return fm;
}

// Special parser for music
function parseLuaMusic(musicStr) {
    if (DEBUG_MODE) console.log("Parsing music:", musicStr);
    
    const music = {
        path: ''
    };
    
    const cleaned = musicStr.trim().slice(1, -1).trim(); // Remove outer {}
    
    if (!cleaned) return music;
    
    const props = splitLuaTableEntries(cleaned);
    
    props.forEach(prop => {
        if (!prop) return;
        const [key, value] = prop.split('=').map(s => s.trim());
        if (key && value) {
            music[key] = parseLuaValue(value);
        }
    });
    
    if (DEBUG_MODE) console.log("Parsed music:", music);
    return music;
}

// Helper function to split Lua table entries while handling nested tables
function splitLuaTableEntries(str) {
    if (DEBUG_MODE) console.log("Splitting table entries:", str);
    
    const entries = [];
    let current = '';
    let depth = 0;
    
    for (let i = 0; i < str.length; i++) {
        const char = str[i];
        
        if (char === '{') depth++;
        if (char === '}') depth--;
        
        if (char === ',' && depth === 0) {
            entries.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    if (current.trim()) {
        entries.push(current.trim());
    }
    
    if (DEBUG_MODE) console.log("Split entries:", entries);
    return entries;
}

// Helper function to parse Lua keys (strings or identifiers)
function parseLuaKey(keyStr) {
    if (DEBUG_MODE) console.log("Parsing key:", keyStr);
    
    // Handle string keys (quoted)
    if (keyStr.startsWith('"') && keyStr.endsWith('"') || 
        keyStr.startsWith("'") && keyStr.endsWith("'")) {
        return keyStr.slice(1, -1);
    }
    
    // Handle numeric keys
    if (/^-?\d+$/.test(keyStr)) {
        return parseInt(keyStr);
    }
    
    // Handle boolean keys
    if (keyStr === 'true') return true;
    if (keyStr === 'false') return false;
    
    // Default to using the string as-is (for identifiers)
    return keyStr;
}

// Helper function to parse Lua values
function parseLuaValue(valueStr) {
    if (DEBUG_MODE) console.log("Parsing value:", valueStr);
    
    // Handle nested tables
    if (valueStr.startsWith('{') && valueStr.endsWith('}')) {
        return parseLuaTable(valueStr);
    }
    
    // Handle strings
    if (valueStr.startsWith('"') && valueStr.endsWith('"') || 
        valueStr.startsWith("'") && valueStr.endsWith("'")) {
        return valueStr.slice(1, -1);
    }
    
    // Handle numbers
    if (/^-?\d+\.?\d*$/.test(valueStr)) {
        return parseFloat(valueStr);
    }
    
    // Handle booleans
    if (valueStr === 'true') return true;
    if (valueStr === 'false') return false;
    
    // Handle nil
    if (valueStr === 'nil') return null;
    
    // Default to string (might be a variable reference)
    return valueStr;
}

function parseConfigContent(luaString) {
    if (DEBUG_MODE) console.log("Starting to parse config content...");
    
    // First extract all local variable definitions
    const localVars = {};
    const localPattern = /local\s+(\w+)\s*=\s*({[\s\S]*?})(?=\s*(?:local|function|return|$))/g;
    let localMatch;
    
    if (DEBUG_MODE) console.log("Extracting local variables...");
    
    while (localMatch = localPattern.exec(luaString)) {
        const varName = localMatch[1];
        const varValue = localMatch[2];
        
        if (DEBUG_MODE) console.log("Found local var:", varName);
        
        try {
            localVars[varName] = parseLuaTable(varValue);
            if (DEBUG_MODE) console.log("Parsed var content:", localVars[varName]);
        } catch (e) {
            if (DEBUG_MODE) console.error(`Failed to parse ${varName}:`, e);
            throw new Error(`Failed to parse variable ${varName}: ${e.message}`);
        }
    }

    // Then extract the return statement
    if (DEBUG_MODE) console.log("Extracting return statement...");
    const returnMatch = luaString.match(/return\s*({[\s\S]*?})\s*$/);
    if (!returnMatch) {
        throw new Error("No return statement found in Lua config");
    }

    // Process the return table
    let returnTable;
    try {
        returnTable = parseLuaTable(returnMatch[1]);
        if (DEBUG_MODE) console.log("Parsed return table:", returnTable);
    } catch (e) {
        if (DEBUG_MODE) console.error("Failed to parse return table:", e);
        throw new Error(`Failed to parse return table: ${e.message}`);
    }
    
    // Replace variable references in encounters array with actual values
    if (returnTable.encounters && Array.isArray(returnTable.encounters)) {
        if (DEBUG_MODE) console.log("Processing encounters array...");
        
        returnTable.encounters = returnTable.encounters.map(name => {
            const cleanName = typeof name === 'string' ? name.trim() : name;
            
            if (DEBUG_MODE) console.log("Processing encounter reference:", cleanName);
            
            if (localVars[cleanName]) {
                return localVars[cleanName];
            }
            throw new Error(`Undefined encounter reference: ${cleanName}`);
        });
    }

    return {
        ...returnTable,
        ...localVars
    };
}

function jsonToLuaTable(obj, indent = '    ', isGrid = false) {
    if (obj === null || obj === undefined) {
        return 'nil';
    }
    
    if (Array.isArray(obj)) {
        if (obj.length === 0) return '{}';
        
        // Special handling for grid arrays
        if (isGrid && obj.length > 0 && Array.isArray(obj[0])) {
            let result = '{\n';
            obj.forEach(row => {
                result += `${indent}{${row.join(',')}},\n`;
            });
            result += `${indent.substring(0, indent.length - 4)}}`;
            return result;
        }
        
        // Regular array handling
        let result = '{\n';
        obj.forEach((item, index) => {
            result += `${indent}${jsonToLuaTable(item, indent + '    ')},\n`;
        });
        result += `${indent.substring(0, indent.length - 4)}}`;
        return result;
    } else if (typeof obj === 'object') {
        const keys = Object.keys(obj);
        if (keys.length === 0) return '{}';
        
        let result = '{\n';
        keys.forEach(key => {
            // Special handling for obstacles
            if (key === 'enemies' || key === 'obstacles') {
                result += `${indent}${key}={\n`;
                if (Array.isArray(obj[key])) {
                    obj[key].forEach(item => {
                        if (typeof item === 'object') {
                            result += `${indent}    {`;
                            const props = [];
                            for (const prop in item) {
                                props.push(`${prop}=${jsonToLuaTable(item[prop], indent + '        ')}`);
                            }
                            result += props.join(',');
                            result += `},\n`;
                        }
                    });
                }
                result += `${indent}},\n`;
                return;
            }
            
            // Special handling for grid arrays
            if (Array.isArray(obj[key]) && obj[key].length > 0 && Array.isArray(obj[key][0])) {
                result += `${indent}${key}=${jsonToLuaTable(obj[key], indent, true)},\n`;
                return;
            }
            
            // Handle numeric keys (array indices)
            const isNumericKey = String(Number(key)) === key;
            const keyStr = isNumericKey ? '' : `${key}=`;
            result += `${indent}${keyStr}${jsonToLuaTable(obj[key], indent + '    ')},\n`;
        });
        result += `${indent.substring(0, indent.length - 4)}}`;
        return result;
    } else if (typeof obj === 'string') {
        // Escape quotes if needed
        if (obj.includes('"') || obj.includes('\\') || obj.includes('\n')) {
            return `'${obj.replace(/'/g, "\\'")}'`;
        }
        return `"${obj}"`;
    } else if (typeof obj === 'boolean') {
        return obj ? 'true' : 'false';
    }
    
    return String(obj);
}

function convertJsonToLua(obj, indent = '    ', isGrid = false) {
    if (obj === null || obj === undefined) {
        return 'nil';
    }
    
    if (Array.isArray(obj)) {
        if (obj.length === 0) return '{}';
        
        // Special handling for grid arrays
        if (isGrid && obj.length > 0 && Array.isArray(obj[0])) {
            let result = '{\n';
            obj.forEach(row => {
                result += `${indent}{${row.join(',')}},\n`;
            });
            result += `${indent.substring(0, indent.length - 4)}}`;
            return result;
        }
        
        // Regular array handling
        let result = '{\n';
        obj.forEach((item, index) => {
            result += `${indent}${convertJsonToLua(item, indent + '    ')},\n`;
        });
        result += `${indent.substring(0, indent.length - 4)}}`;
        return result;
    } else if (typeof obj === 'object') {
        const keys = Object.keys(obj);
        if (keys.length === 0) return '{}';
        
        let result = '{\n';
        keys.forEach(key => {
            // Special handling for obstacles
            if (key === 'enemies' || key === 'obstacles') {
                result += `${indent}${key}={\n`;
                obj[key].forEach(item => {
                    result += `${indent}    {`;
                    const props = [];
                    for (const prop in item) {
                        // Properly format each property without extra quotes
                        const val = convertJsonToLua(item[prop], indent + '        ');
                        props.push(`${prop}=${val}`);
                    }
                    result += props.join(',');
                    result += `},\n`;
                });
                result += `${indent}},\n`;
                return;
            }
            
            // Special handling for grid arrays
            if (Array.isArray(obj[key]) && obj[key].length > 0 && Array.isArray(obj[key][0])) {
                result += `${indent}${key}=${convertJsonToLua(obj[key], indent, true)},\n`;
                return;
            }
            
            // Handle numeric keys (array indices)
            const isNumericKey = String(Number(key)) === key;
            const keyStr = isNumericKey ? '' : `${key}=`;
            result += `${indent}${keyStr}${convertJsonToLua(obj[key], indent + '    ')},\n`;
        });
        result += `${indent.substring(0, indent.length - 4)}}`;
        return result;
    } else if (typeof obj === 'string') {
        // Escape quotes if needed, but don't add extra quotes
        if (obj.includes('"') || obj.includes('\\') || obj.includes('\n')) {
            return `'${obj.replace(/'/g, "\\'")}'`;
        }
        return `"${obj}"`;
    } else if (typeof obj === 'boolean') {
        return obj ? 'true' : 'false';
    }
    
    return String(obj);
}

function generateLuaString() {
    // Ensure config.encounters exists and is an array
    if (!config.encounters || !Array.isArray(config.encounters)) {
        config.encounters = [];
    }

    const output = [];

    // Generate each encounter
    config.encounters.forEach(encounter => {
        if (!encounter.name) return;

        // First, create a properly numbered player_positions array
        const numberedPlayerPositions = Array(3).fill().map(() => Array(6).fill(0));
        let playerCounter = 1;
        
        // First pass to find all player positions
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 6; col++) {
                if (encounter.player_positions && encounter.player_positions[row] && 
                    encounter.player_positions[row][col] > 0) {
                    numberedPlayerPositions[row][col] = playerCounter++;
                }
            }
        }

        output.push(`local ${encounter.name} = {`);
        output.push(`    name="${encounter.name}",`);
        output.push(`    path="${encounter.path || ''}",`);
        output.push(`    weight=${encounter.weight || 10},`);

        // Handle enemies
        if (encounter.enemies && Array.isArray(encounter.enemies)) {
            output.push(`    enemies={`);
            encounter.enemies.forEach(enemy => {
                if (enemy && typeof enemy === 'object') {
                    const props = [];
                    if (enemy.name) props.push(`name="${enemy.name.replace(/"/g, '\\"')}"`);
                    if (enemy.rank) props.push(`rank=${enemy.rank}`);
                    if (enemy.nickname) props.push(`nickname="${enemy.nickname.replace(/"/g, '\\"')}"`);
                    output.push(`        {${props.join(',')}},`);
                }
            });
            output.push(`    },`);
        }
        
        // Handle obstacles
        if (encounter.obstacles && Array.isArray(encounter.obstacles)) {
            output.push(`    obstacles={`);
            encounter.obstacles.forEach(obstacle => {
                if (obstacle && typeof obstacle === 'object') {
                    const props = [];
                    if (obstacle.name) props.push(`name="${obstacle.name.replace(/"/g, '\\"')}"`);
                    output.push(`        {${props.join(',')}},`);
                }
            });
            output.push(`    },`);
        }

        // Handle positions
        if (encounter.positions && Array.isArray(encounter.positions)) {
            output.push(`    positions={`);
            encounter.positions.forEach(row => {
                if (Array.isArray(row)) {
                    output.push(`        {${row.join(',')}},`);
                }
            });
            output.push(`    },`);
        }
        
        // Handle obstacle positions
        if (encounter.obstacle_positions && Array.isArray(encounter.obstacle_positions)) {
            output.push(`    obstacle_positions={`);
            encounter.obstacle_positions.forEach(row => {
                if (Array.isArray(row)) {
                    output.push(`        {${row.join(',')}},`);
                }
            });
            output.push(`    },`);
        }

        // Handle player positions with proper numbering
        output.push(`    player_positions={`);
        numberedPlayerPositions.forEach(row => {
            if (Array.isArray(row)) {
                output.push(`        {${row.join(',')}},`);
            }
        });
        output.push(`    },`);

        // Handle tiles
        if (encounter.tiles && Array.isArray(encounter.tiles)) {
            output.push(`    tiles={`);
            encounter.tiles.forEach(row => {
                if (Array.isArray(row)) {
                    output.push(`        {${row.join(',')}},`);
                }
            });
            output.push(`    },`);
        }

        // Handle teams
        if (encounter.teams && Array.isArray(encounter.teams)) {
            output.push(`    teams={`);
            encounter.teams.forEach(row => {
                if (Array.isArray(row)) {
                    output.push(`        {${row.join(',')}},`);
                }
            });
            output.push(`    },`);
        }

        // Handle other properties
        if (encounter.music?.path) {
            output.push(`    music={path="${encounter.music.path.replace(/"/g, '\\"')}"},`);
        }
        if (encounter.results_callback) {
            output.push(`    results_callback="${encounter.results_callback.replace(/"/g, '\\"')}",`);
        }
        if (encounter.freedom_mission?.enabled) {
            output.push(`    freedom_mission={`);
            output.push(`        enabled=true,`);
            output.push(`        turn_count=${encounter.freedom_mission.turn_count || 5},`);
            output.push(`        player_can_flip=${encounter.freedom_mission.player_can_flip ? 'true' : 'false'}`);
            output.push(`    },`);
        }

        output.push('}');
        output.push(''); // Empty line between encounters
    });

    // Add return statement
    output.push('return {');
    output.push(`    minimum_steps_before_encounter=${config.minimum_steps_before_encounter || 80},`);
    output.push(`    encounter_chance_per_step=${config.encounter_chance_per_step || 0.05},`);
    output.push(`    encounters={${config.encounters.map(e => e.name).filter(Boolean).join(',')}}`);
    output.push('}');

    return output.join('\n');
}



// =============================================
// Utility Functions
// =============================================

function showStatus(message, type) {
    const status = $('#status-message');
    status.text(message)
          .removeClass('success error')
          .addClass(type)
          .stop(true, true)
          .fadeIn()
          .delay(3000)
          .fadeOut();
}


// =============================================
// Initialize Editor
// =============================================

$(document).ready(function() {
    initializeEditor();
    setupEventHandlers();
    initializeDarkMode(); // Add this line

    if (DEBUG_MODE) {
        console.log("Editor initialized in debug mode");
        window.debugGetConfig = () => config;
        window.debugReload = () => {
            localStorage.removeItem('battleConfig');
            location.reload();
        };
    }
});

</script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</body>
</html>